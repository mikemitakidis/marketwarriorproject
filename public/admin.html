<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Warrior - Admin Control Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f1f5f9; color: #1e293b; }
        
        /* LOGIN SCREEN */
        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #1e293b 100%); }
        .login-container { background: white; padding: 50px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 450px; text-align: center; }
        .login-logo { font-size: 60px; margin-bottom: 20px; }
        .login-title { font-size: 2em; color: #1e293b; margin-bottom: 10px; }
        .login-subtitle { color: #64748b; margin-bottom: 40px; }
        .login-form .form-group { margin-bottom: 20px; text-align: left; }
        .login-form label { display: block; margin-bottom: 8px; font-weight: 600; color: #475569; }
        .login-form input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1em; }
        .login-form input:focus { outline: none; border-color: #667eea; }
        .login-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
        .login-error { background: #fee2e2; color: #dc2626; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        
        /* ADMIN PANEL */
        .admin-panel { display: none; }
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: linear-gradient(180deg, #1e293b 0%, #334155 100%); padding: 20px 0; overflow-y: auto; z-index: 100; }
        .logo-section { text-align: center; padding: 0 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo-section h2 { color: white; font-size: 1.4em; margin-top: 12px; }
        .logo-icon { font-size: 45px; }
        .admin-badge { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.75em; font-weight: 600; display: inline-block; margin-top: 10px; }
        .nav-menu { padding: 20px 0; }
        .nav-item { padding: 14px 25px; color: #cbd5e1; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 12px; font-size: 0.9em; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: #667eea; color: white; border-left: 4px solid #fbbf24; }
        .nav-icon { font-size: 1.2em; width: 24px; text-align: center; }
        .nav-divider { border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 20px; }
        .logout-btn { margin: 20px; padding: 12px; background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9em; }
        .logout-btn:hover { background: rgba(239, 68, 68, 0.4); color: white; }
        
        .main-content { margin-left: 260px; padding: 25px; min-height: 100vh; }
        .top-bar { background: white; padding: 18px 25px; border-radius: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .page-title { font-size: 1.8em; color: #1e293b; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 22px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stat-title { color: #64748b; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-icon { font-size: 1.8em; }
        .stat-value { font-size: 2.2em; font-weight: 700; color: #1e293b; }
        .stat-change { margin-top: 8px; font-size: 0.85em; }
        .stat-change.positive { color: #10b981; }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .card-title { font-size: 1.4em; color: #1e293b; }
        .card-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .data-table thead { background: #f8fafc; }
        .data-table th { padding: 14px 12px; text-align: left; font-weight: 600; color: #64748b; font-size: 0.8em; text-transform: uppercase; }
        .data-table td { padding: 14px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9em; }
        .data-table tr:hover { background: #f8fafc; }
        
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #94a3b8; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8em; }
        .btn-outline { background: transparent; border: 2px solid #667eea; color: #667eea; }
        
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #475569; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95em; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        .badge { padding: 4px 10px; border-radius: 10px; font-size: 0.75em; font-weight: 600; white-space: nowrap; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-purple { background: #ede9fe; color: #5b21b6; }
        
        .search-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-bar input { flex: 1; min-width: 200px; padding: 12px 18px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95em; }
        .search-bar input:focus { outline: none; border-color: #667eea; }
        .search-bar select { padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95em; background: white; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 35px; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-size: 1.6em; color: #1e293b; }
        .close-modal { font-size: 1.8em; cursor: pointer; color: #94a3b8; background: none; border: none; line-height: 1; }
        
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: #64748b; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .alert { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        
        .chart-container { height: 300px; margin-top: 20px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
        .empty-state-icon { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }
        
        @media (max-width: 768px) {
            .sidebar { width: 70px; padding: 10px 0; }
            .logo-section h2, .nav-item span:not(.nav-icon), .admin-badge { display: none; }
            .nav-item { justify-content: center; padding: 15px; }
            .main-content { margin-left: 70px; padding: 15px; }
            .logout-btn span { display: none; }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">‚öîÔ∏è</div>
            <h1 class="login-title">Admin Control Panel</h1>
            <p class="login-subtitle">Market Warrior Management System</p>
            <div class="login-error" id="loginError"></div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Admin Email</label>
                    <input type="email" id="adminEmail" placeholder="Enter admin email" required>
                </div>
                <div class="form-group">
                    <label>Admin Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="login-btn">üîê Access Admin Panel</button>
            </form>
            <p style="margin-top: 25px; color: #94a3b8; font-size: 0.85em;">Only authorized administrators can access this panel.</p>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div class="admin-panel" id="adminPanel">
        <aside class="sidebar">
            <div class="logo-section">
                <div class="logo-icon">‚öîÔ∏è</div>
                <h2>Market Warrior</h2>
                <span class="admin-badge">ADMIN PANEL</span>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" onclick="showSection('dashboard', this)"><span class="nav-icon">üìä</span><span>Dashboard</span></div>
                <div class="nav-item" onclick="showSection('users', this)"><span class="nav-icon">üë•</span><span>Users</span></div>
                <div class="nav-item" onclick="showSection('content', this)"><span class="nav-icon">üìù</span><span>Content</span></div>
                <div class="nav-item" onclick="showSection('promo', this)"><span class="nav-icon">üéüÔ∏è</span><span>Promo Codes</span></div>
                <div class="nav-divider"></div>
                <div class="nav-item" onclick="showSection('affiliates', this)"><span class="nav-icon">üí∞</span><span>Affiliates</span></div>
                <div class="nav-item" onclick="showSection('analytics', this)"><span class="nav-icon">üìà</span><span>Analytics</span></div>
                <div class="nav-item" onclick="showSection('emails', this)"><span class="nav-icon">üìß</span><span>Emails</span></div>
                <div class="nav-divider"></div>
                <div class="nav-item" onclick="showSection('community', this)"><span class="nav-icon">üí¨</span><span>Community</span></div>
                <div class="nav-item" onclick="showSection('livefeed', this)"><span class="nav-icon">üì°</span><span>Live Feed</span></div>
                <div class="nav-item" onclick="showSection('certificates', this)"><span class="nav-icon">üéì</span><span>Certificates</span></div>
            </nav>
            <button class="logout-btn" onclick="handleLogout()"><span>üö™</span><span>Logout</span></button>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <div style="text-align: right;">
                        <div style="font-weight: 600;" id="adminName">Admin</div>
                        <div style="font-size: 0.8em; color: #64748b;" id="adminEmailDisplay">admin@marketwarrior.club</div>
                    </div>
                    <div class="user-avatar" id="adminAvatar">A</div>
                </div>
            </div>
            <div id="alertContainer"></div>

            <!-- DASHBOARD -->
            <section id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">Total Revenue</span><span class="stat-icon">üí∞</span></div><div class="stat-value" id="totalRevenue">$0</div><div class="stat-change positive" id="revenueChange">Loading...</div></div>
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">Total Users</span><span class="stat-icon">üë•</span></div><div class="stat-value" id="totalUsers">0</div><div class="stat-change positive" id="usersChange">Loading...</div></div>
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">Paid Users</span><span class="stat-icon">‚úÖ</span></div><div class="stat-value" id="paidUsers">0</div><div class="stat-change" id="conversionRate">0% conversion</div></div>
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">Completion Rate</span><span class="stat-icon">üèÜ</span></div><div class="stat-value" id="completionRate">0%</div><div class="stat-change positive" id="completedCount">0 completed</div></div>
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">Active Promos</span><span class="stat-icon">üéüÔ∏è</span></div><div class="stat-value" id="activePromos">0</div><div class="stat-change" id="promoUsage">0 total uses</div></div>
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">Affiliate Earnings</span><span class="stat-icon">ü§ù</span></div><div class="stat-value" id="affiliateEarnings">$0</div><div class="stat-change" id="affiliateCount">0 affiliates</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üìã Recent Activity</h2><button class="btn btn-outline btn-sm" onclick="loadRecentActivity()">‚Üª Refresh</button></div>
                    <div class="table-container">
                        <table class="data-table"><thead><tr><th>User</th><th>Activity</th><th>Details</th><th>Time</th></tr></thead><tbody id="activityTableBody"><tr><td colspan="4" class="loading"><div class="spinner"></div> Loading...</td></tr></tbody></table>
                    </div>
                </div>
            </section>

            <!-- USERS -->
            <section id="users" class="content-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üë• User Management</h2><div class="card-actions"><button class="btn btn-success btn-sm" onclick="exportUsers()">üì• Export CSV</button><button class="btn btn-primary btn-sm" onclick="openModal('addUserModal')">+ Add User</button></div></div>
                    <div class="search-bar"><input type="text" id="userSearch" placeholder="Search by name or email..." onkeyup="filterUsers()"><select id="userFilter" onchange="filterUsers()"><option value="all">All Users</option><option value="paid">Paid Only</option><option value="unpaid">Unpaid Only</option><option value="completed">Completed</option><option value="admin">Admins</option></select></div>
                    <div class="table-container"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Progress</th><th>Joined</th><th>Actions</th></tr></thead><tbody id="usersTableBody"><tr><td colspan="6" class="loading"><div class="spinner"></div> Loading...</td></tr></tbody></table></div>
                </div>
            </section>

            <!-- CONTENT -->
            <section id="content" class="content-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üìù Content Editor</h2></div>
                    <div class="form-group"><label>Select Day to Edit</label><select id="daySelector" onchange="loadDayContent()"><option value="">-- Select Day --</option></select></div>
                    <div id="contentEditor" style="display: none;">
                        <div class="form-group"><label>Day Title</label><input type="text" id="dayTitle" placeholder="Day title..."></div>
                        <div class="form-group"><label>Video URL (YouTube)</label><input type="text" id="videoUrl" placeholder="https://youtube.com/watch?v=..."></div>
                        <div class="form-group"><label>Quiz Questions (JSON)</label><textarea id="quizQuestions" rows="6" placeholder='[{"question": "...", "options": [...], "correct": 0}]'></textarea></div>
                        <div class="form-group"><label>Task Description</label><textarea id="taskDescription" rows="4" placeholder="Task instructions..."></textarea></div>
                        <button class="btn btn-success" onclick="saveContent()">üíæ Save Changes</button>
                    </div>
                </div>
            </section>

            <!-- PROMO CODES -->
            <section id="promo" class="content-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üéüÔ∏è Promo Codes</h2><button class="btn btn-primary" onclick="openModal('addPromoModal')">+ Create Promo Code</button></div>
                    <div class="table-container"><table class="data-table"><thead><tr><th>Code</th><th>Discount</th><th>Description</th><th>Used / Limit</th><th>Expires</th><th>Status</th><th>Actions</th></tr></thead><tbody id="promoTableBody"><tr><td colspan="7" class="loading"><div class="spinner"></div> Loading...</td></tr></tbody></table></div>
                </div>
            </section>

            <!-- AFFILIATES -->
            <section id="affiliates" class="content-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üí∞ Affiliate Program</h2><div class="card-actions"><button class="btn btn-success" onclick="processPayouts()">üí∏ Process Payouts</button><button class="btn btn-primary" onclick="openModal('addAffiliateModal')">+ Add Affiliate</button></div></div>
                    <div class="table-container"><table class="data-table"><thead><tr><th>Affiliate</th><th>Code</th><th>Referrals</th><th>Total Earnings</th><th>Pending</th><th>Paid Out</th><th>Actions</th></tr></thead><tbody id="affiliatesTableBody"><tr><td colspan="7" class="loading"><div class="spinner"></div> Loading...</td></tr></tbody></table></div>
                </div>
            </section>

            <!-- ANALYTICS -->
            <section id="analytics" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">Today's Revenue</span><span class="stat-icon">üìÖ</span></div><div class="stat-value" id="todayRevenue">$0</div></div>
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">This Week</span><span class="stat-icon">üìÜ</span></div><div class="stat-value" id="weekRevenue">$0</div></div>
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">This Month</span><span class="stat-icon">üóìÔ∏è</span></div><div class="stat-value" id="monthRevenue">$0</div></div>
                    <div class="stat-card"><div class="stat-header"><span class="stat-title">Avg. Order Value</span><span class="stat-icon">üíµ</span></div><div class="stat-value" id="avgOrderValue">$0</div></div>
                </div>
                <div class="card"><h2 class="card-title">üìà Revenue Chart</h2><div class="chart-container"><canvas id="revenueChart"></canvas></div></div>
                <div class="card"><h2 class="card-title">üë• User Growth</h2><div class="chart-container"><canvas id="usersChart"></canvas></div></div>
            </section>

            <!-- EMAILS -->
            <section id="emails" class="content-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üìß Email Campaign</h2></div>
                    <div class="form-row"><div class="form-group"><label>Recipients</label><select id="emailRecipients"><option value="all">All Users</option><option value="paid">Paid Users</option><option value="unpaid">Unpaid Users</option><option value="completed">Completed</option></select></div><div class="form-group"><label>Recipient Count</label><input type="text" id="recipientCount" value="0 users" readonly style="background: #f8fafc;"></div></div>
                    <div class="form-group"><label>Email Subject</label><input type="text" id="emailSubject" placeholder="Enter email subject..."></div>
                    <div class="form-group"><label>Email Content</label><textarea id="emailContent" rows="10" placeholder="Write your email..."></textarea></div>
                    <div style="display: flex; gap: 15px;"><button class="btn btn-secondary" onclick="previewEmail()">üëÅÔ∏è Preview</button><button class="btn btn-success" onclick="sendEmail()">üì§ Send Campaign</button></div>
                </div>
            </section>

            <!-- COMMUNITY -->
            <section id="community" class="content-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üí¨ Community Management</h2></div>
                    <div class="table-container"><table class="data-table"><thead><tr><th>Title</th><th>Author</th><th>Day Tag</th><th>Replies</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody id="postsTableBody"><tr><td colspan="7" class="loading"><div class="spinner"></div> Loading...</td></tr></tbody></table></div>
                </div>
            </section>

            <!-- LIVE FEED -->
            <section id="livefeed" class="content-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üì° Post Announcement</h2></div>
                    <div class="form-row"><div class="form-group"><label>Type</label><select id="feedType"><option value="announcement">üì¢ Announcement</option><option value="alert">‚ö†Ô∏è Alert</option><option value="tip">üí° Trading Tip</option></select></div><div class="form-group"><label>Expires (optional)</label><input type="datetime-local" id="feedExpires"></div></div>
                    <div class="form-group"><label>Message</label><textarea id="feedMessage" rows="4" placeholder="Enter your announcement..."></textarea></div>
                    <button class="btn btn-success" onclick="postToFeed()">üì° Post to Live Feed</button>
                </div>
                <div class="card"><h2 class="card-title">üìú Recent Announcements</h2><div id="feedList"><div class="loading"><div class="spinner"></div> Loading...</div></div></div>
            </section>

            <!-- CERTIFICATES -->
            <section id="certificates" class="content-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üéì Certificate Management</h2><button class="btn btn-primary" onclick="openModal('createCertModal')">+ Create Certificate</button></div>
                    <p style="color: #64748b; margin-bottom: 20px;">Create certificates manually for special cases.</p>
                    <div class="table-container"><table class="data-table"><thead><tr><th>Name</th><th>Certificate ID</th><th>Score</th><th>Issued</th><th>Status</th><th>Actions</th></tr></thead><tbody id="certificatesTableBody"><tr><td colspan="6" class="loading"><div class="spinner"></div> Loading...</td></tr></tbody></table></div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    <div class="modal" id="addUserModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Add New User</h2><button class="close-modal" onclick="closeModal('addUserModal')">&times;</button></div><div class="form-group"><label>Full Name</label><input type="text" id="newUserName" placeholder="Enter full name"></div><div class="form-group"><label>Email</label><input type="email" id="newUserEmail" placeholder="Enter email"></div><div class="form-group"><label>Password</label><input type="password" id="newUserPassword" placeholder="Enter password"></div><div class="form-group"><label><input type="checkbox" id="newUserPaid"> Grant Paid Access</label></div><div class="form-group"><label><input type="checkbox" id="newUserAdmin"> Make Admin</label></div><button class="btn btn-success" onclick="addUser()">Create User</button></div></div>
    <div class="modal" id="editUserModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Edit User</h2><button class="close-modal" onclick="closeModal('editUserModal')">&times;</button></div><input type="hidden" id="editUserId"><div class="form-group"><label>Full Name</label><input type="text" id="editUserName"></div><div class="form-group"><label>Email</label><input type="email" id="editUserEmail" readonly style="background: #f8fafc;"></div><div class="form-group"><label>Current Day</label><input type="number" id="editUserDay" min="1" max="30"></div><div class="form-group"><label><input type="checkbox" id="editUserPaid"> Has Paid Access</label></div><div class="form-group"><label><input type="checkbox" id="editUserAdmin"> Is Admin</label></div><div class="form-group"><label><input type="checkbox" id="editUserCompleted"> Challenge Completed</label></div><button class="btn btn-success" onclick="saveUser()">Save Changes</button></div></div>
    <div class="modal" id="addPromoModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Create Promo Code</h2><button class="close-modal" onclick="closeModal('addPromoModal')">&times;</button></div><div class="form-group"><label>Promo Code</label><input type="text" id="newPromoCode" placeholder="e.g., LAUNCH50" style="text-transform: uppercase;"></div><div class="form-group"><label>Discount %</label><input type="number" id="newPromoDiscount" min="1" max="100" placeholder="e.g., 20"></div><div class="form-group"><label>Description</label><input type="text" id="newPromoDesc" placeholder="e.g., Launch special"></div><div class="form-row"><div class="form-group"><label>Usage Limit</label><input type="number" id="newPromoLimit" placeholder="e.g., 100"></div><div class="form-group"><label>Expires At</label><input type="datetime-local" id="newPromoExpires"></div></div><button class="btn btn-success" onclick="createPromo()">Create Promo Code</button></div></div>
    <div class="modal" id="addAffiliateModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Add Affiliate</h2><button class="close-modal" onclick="closeModal('addAffiliateModal')">&times;</button></div><div class="form-group"><label>Select User</label><select id="affiliateUserId"><option value="">-- Select a user --</option></select></div><div class="form-group"><label>Affiliate Code</label><input type="text" id="affiliateCode" placeholder="e.g., MIKE2025" style="text-transform: uppercase;"></div><div class="form-group"><label>Commission Rate (%)</label><input type="number" id="affiliateRate" value="30" min="1" max="50"></div><div class="form-group"><label>Payment Email</label><input type="email" id="affiliatePaymentEmail" placeholder="email@example.com"></div><button class="btn btn-success" onclick="createAffiliate()">Create Affiliate</button></div></div>
    <div class="modal" id="createCertModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Create Certificate</h2><button class="close-modal" onclick="closeModal('createCertModal')">&times;</button></div><div class="form-group"><label>Full Name</label><input type="text" id="certName" placeholder="Enter full name"></div><div class="form-group"><label>Final Score (%)</label><input type="number" id="certScore" min="60" max="100" value="85"></div><div class="form-group"><label>Link to User (optional)</label><select id="certUserId"><option value="">-- No user link --</option></select></div><button class="btn btn-success" onclick="createCertificate()">Generate Certificate</button></div></div>

    <script>
        const SUPABASE_URL = 'https://gvpaemdpmwyncdztlczy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cGFlbWRwbXd5bmNkenRsY3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMjI4NjUsImV4cCI6MjA2NDc5ODg2NX0.0lPAN-NLWEs5vJjDYVq1BdaQcOb11s00CI_0Nbvfwqc';
        const ALLOWED_ADMIN_EMAIL = 'mitakidis.mike@gmail.com';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentAdmin = null;
        let allUsers = [];
        let allPromoCodes = [];
        let allAffiliates = [];
        let revenueChart = null;
        let usersChart = null;

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (email.toLowerCase() !== ALLOWED_ADMIN_EMAIL.toLowerCase()) {
                errorDiv.textContent = '‚ùå Access denied. This email is not authorized.';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                const { data: userData, error: userError } = await supabase.from('users').select('is_admin, full_name').eq('id', data.user.id).single();
                if (userError || !userData?.is_admin) {
                    await supabase.auth.signOut();
                    errorDiv.textContent = '‚ùå Access denied. You are not an administrator.';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                currentAdmin = { id: data.user.id, email: data.user.email, name: userData.full_name || 'Admin' };
                showAdminPanel();
            } catch (err) {
                errorDiv.textContent = '‚ùå ' + (err.message || 'Invalid credentials');
                errorDiv.style.display = 'block';
            }
        }

        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminName').textContent = currentAdmin.name;
            document.getElementById('adminEmailDisplay').textContent = currentAdmin.email;
            document.getElementById('adminAvatar').textContent = currentAdmin.name.charAt(0).toUpperCase();
            loadDashboard(); loadUsers(); loadPromoCodes(); loadAffiliates(); loadCommunityPosts(); loadLiveFeed(); loadCertificates(); populateDaySelector(); loadAnalytics();
        }

        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                await supabase.auth.signOut();
                currentAdmin = null;
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                const { data: userData } = await supabase.from('users').select('is_admin, full_name').eq('id', session.user.id).single();
                if (userData?.is_admin && session.user.email.toLowerCase() === ALLOWED_ADMIN_EMAIL.toLowerCase()) {
                    currentAdmin = { id: session.user.id, email: session.user.email, name: userData.full_name || 'Admin' };
                    showAdminPanel();
                }
            }
        }

        function showSection(sectionId, navElement) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if (navElement) navElement.classList.add('active');
            const titles = { 'dashboard': 'üìä Dashboard', 'users': 'üë• Users', 'content': 'üìù Content', 'promo': 'üéüÔ∏è Promo Codes', 'affiliates': 'üí∞ Affiliates', 'analytics': 'üìà Analytics', 'emails': 'üìß Emails', 'community': 'üí¨ Community', 'livefeed': 'üì° Live Feed', 'certificates': 'üéì Certificates' };
            document.getElementById('pageTitle').textContent = titles[sectionId] || sectionId;
        }

        async function loadDashboard() {
            try {
                const { data: users, count } = await supabase.from('users').select('*', { count: 'exact' });
                const totalUsers = count || 0;
                const paidUsers = users?.filter(u => u.has_paid).length || 0;
                const completedUsers = users?.filter(u => u.challenge_completed).length || 0;
                const totalRevenue = users?.filter(u => u.has_paid).reduce((sum, u) => sum + (u.payment_amount || 39.99), 0) || 0;
                
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('paidUsers').textContent = paidUsers;
                document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toFixed(2);
                document.getElementById('completionRate').textContent = paidUsers > 0 ? Math.round((completedUsers / paidUsers) * 100) + '%' : '0%';
                document.getElementById('conversionRate').textContent = totalUsers > 0 ? Math.round((paidUsers / totalUsers) * 100) + '% conversion' : '0%';
                document.getElementById('completedCount').textContent = completedUsers + ' completed';
                document.getElementById('usersChange').textContent = '‚Üë Total registered';
                document.getElementById('revenueChange').textContent = '$39.99 per user';
                
                const { data: promos } = await supabase.from('promo_codes').select('*');
                document.getElementById('activePromos').textContent = promos?.filter(p => p.is_active).length || 0;
                document.getElementById('promoUsage').textContent = (promos?.reduce((sum, p) => sum + (p.usage_count || 0), 0) || 0) + ' total uses';
                
                const { data: affiliates } = await supabase.from('affiliates').select('*');
                document.getElementById('affiliateEarnings').textContent = '$' + (affiliates?.reduce((sum, a) => sum + (a.total_earnings || 0), 0) || 0).toFixed(2);
                document.getElementById('affiliateCount').textContent = (affiliates?.length || 0) + ' affiliates';
                
                loadRecentActivity();
            } catch (err) { console.error('Dashboard error:', err); }
        }

        async function loadRecentActivity() {
            try {
                const { data } = await supabase.from('activity_log').select('*').order('created_at', { ascending: false }).limit(20);
                const tbody = document.getElementById('activityTableBody');
                if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No recent activity</td></tr>'; return; }
                tbody.innerHTML = data.map(a => `<tr><td>${a.user_email || 'System'}</td><td><span class="badge badge-info">${a.activity_type}</span></td><td>${a.description || '-'}</td><td>${formatDate(a.created_at)}</td></tr>`).join('');
            } catch (err) { console.error(err); }
        }

        async function loadUsers() {
            try {
                const { data } = await supabase.from('users').select('*').order('created_at', { ascending: false });
                allUsers = data || [];
                renderUsers(allUsers);
                populateUserSelects();
            } catch (err) { console.error(err); }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!users.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users found</td></tr>'; return; }
            tbody.innerHTML = users.map(u => `<tr><td><strong>${u.full_name || 'Unknown'}</strong></td><td>${u.email}</td><td><span class="badge badge-${u.has_paid ? 'success' : 'warning'}">${u.has_paid ? 'Paid' : 'Unpaid'}</span>${u.is_admin ? ' <span class="badge badge-purple">Admin</span>' : ''}</td><td>${u.current_day || 1}/30</td><td>${formatDate(u.created_at)}</td><td><button class="btn btn-sm btn-primary" onclick="editUser('${u.id}')">Edit</button> <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">Delete</button></td></tr>`).join('');
        }

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const filter = document.getElementById('userFilter').value;
            let filtered = allUsers;
            if (search) filtered = filtered.filter(u => (u.full_name || '').toLowerCase().includes(search) || u.email.toLowerCase().includes(search));
            if (filter === 'paid') filtered = filtered.filter(u => u.has_paid);
            else if (filter === 'unpaid') filtered = filtered.filter(u => !u.has_paid);
            else if (filter === 'completed') filtered = filtered.filter(u => u.challenge_completed);
            else if (filter === 'admin') filtered = filtered.filter(u => u.is_admin);
            renderUsers(filtered);
        }

        async function addUser() { showAlert('User creation requires Supabase Admin API - use Supabase dashboard', 'info'); closeModal('addUserModal'); }

        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.full_name || '';
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserDay').value = user.current_day || 1;
            document.getElementById('editUserPaid').checked = user.has_paid;
            document.getElementById('editUserAdmin').checked = user.is_admin;
            document.getElementById('editUserCompleted').checked = user.challenge_completed;
            openModal('editUserModal');
        }

        async function saveUser() {
            const userId = document.getElementById('editUserId').value;
            try {
                const { error } = await supabase.from('users').update({
                    full_name: document.getElementById('editUserName').value,
                    current_day: parseInt(document.getElementById('editUserDay').value),
                    has_paid: document.getElementById('editUserPaid').checked,
                    is_admin: document.getElementById('editUserAdmin').checked,
                    challenge_completed: document.getElementById('editUserCompleted').checked
                }).eq('id', userId);
                if (error) throw error;
                showAlert('User updated!', 'success');
                closeModal('editUserModal');
                loadUsers(); loadDashboard();
            } catch (err) { showAlert('Error: ' + err.message, 'error'); }
        }

        async function deleteUser(userId) {
            if (!confirm('Delete this user?')) return;
            try {
                const { error } = await supabase.from('users').delete().eq('id', userId);
                if (error) throw error;
                showAlert('User deleted!', 'success');
                loadUsers(); loadDashboard();
            } catch (err) { showAlert('Error: ' + err.message, 'error'); }
        }

        function exportUsers() {
            const csv = ['Name,Email,Status,Progress,Joined,Admin', ...allUsers.map(u => `${u.full_name || 'Unknown'},${u.email},${u.has_paid ? 'Paid' : 'Unpaid'},${u.current_day || 1}/30,${formatDate(u.created_at)},${u.is_admin ? 'Yes' : 'No'}`)].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'users.csv'; a.click();
            showAlert('Exported!', 'success');
        }

        function populateUserSelects() {
            const options = allUsers.map(u => `<option value="${u.id}">${u.full_name || u.email}</option>`).join('');
            document.getElementById('affiliateUserId').innerHTML = '<option value="">-- Select --</option>' + options;
            document.getElementById('certUserId').innerHTML = '<option value="">-- No link --</option>' + options;
        }

        async function loadPromoCodes() {
            try {
                const { data } = await supabase.from('promo_codes').select('*').order('created_at', { ascending: false });
                allPromoCodes = data || [];
                const tbody = document.getElementById('promoTableBody');
                if (!data?.length) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No promo codes</td></tr>'; return; }
                tbody.innerHTML = data.map(p => `<tr><td><strong>${p.code}</strong></td><td><span class="badge badge-success">${p.discount_percent}% OFF</span></td><td>${p.description || '-'}</td><td>${p.usage_count || 0} / ${p.usage_limit || '‚àû'}</td><td>${p.expires_at ? formatDate(p.expires_at) : 'Never'}</td><td><span class="badge badge-${p.is_active ? 'success' : 'danger'}">${p.is_active ? 'Active' : 'Inactive'}</span></td><td><button class="btn btn-sm btn-${p.is_active ? 'warning' : 'success'}" onclick="togglePromo('${p.id}', ${!p.is_active})">${p.is_active ? 'Disable' : 'Enable'}</button> <button class="btn btn-sm btn-danger" onclick="deletePromo('${p.id}')">Delete</button></td></tr>`).join('');
            } catch (err) { console.error(err); }
        }

        async function createPromo() {
            const code = document.getElementById('newPromoCode').value.trim().toUpperCase();
            const discount = parseInt(document.getElementById('newPromoDiscount').value);
            if (!code || !discount) { showAlert('Enter code and discount', 'error'); return; }
            try {
                const { error } = await supabase.from('promo_codes').insert({ code, discount_percent: discount, description: document.getElementById('newPromoDesc').value || null, usage_limit: document.getElementById('newPromoLimit').value ? parseInt(document.getElementById('newPromoLimit').value) : null, expires_at: document.getElementById('newPromoExpires').value || null, created_by: currentAdmin.id });
                if (error) throw error;
                showAlert('Promo created!', 'success');
                closeModal('addPromoModal');
                document.getElementById('newPromoCode').value = '';
                document.getElementById('newPromoDiscount').value = '';
                loadPromoCodes(); loadDashboard();
            } catch (err) { showAlert('Error: ' + err.message, 'error'); }
        }

        async function togglePromo(id, state) {
            try { await supabase.from('promo_codes').update({ is_active: state }).eq('id', id); loadPromoCodes(); loadDashboard(); } catch (err) { showAlert('Error', 'error'); }
        }

        async function deletePromo(id) {
            if (!confirm('Delete?')) return;
            try { await supabase.from('promo_codes').delete().eq('id', id); showAlert('Deleted!', 'success'); loadPromoCodes(); loadDashboard(); } catch (err) { showAlert('Error', 'error'); }
        }

        async function loadAffiliates() {
            try {
                const { data } = await supabase.from('affiliates').select('*, users:user_id (email, full_name)').order('created_at', { ascending: false });
                allAffiliates = data || [];
                const tbody = document.getElementById('affiliatesTableBody');
                if (!data?.length) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No affiliates</td></tr>'; return; }
                tbody.innerHTML = data.map(a => `<tr><td>${a.users?.full_name || a.users?.email || 'Unknown'}</td><td><strong>${a.affiliate_code}</strong></td><td>${a.total_referrals || 0}</td><td>$${(a.total_earnings || 0).toFixed(2)}</td><td><span class="badge badge-warning">$${(a.pending_payout || 0).toFixed(2)}</span></td><td>$${(a.paid_out || 0).toFixed(2)}</td><td>${a.pending_payout > 0 ? `<button class="btn btn-sm btn-success" onclick="payAffiliate('${a.id}')">Pay</button>` : ''} <button class="btn btn-sm btn-danger" onclick="deleteAffiliate('${a.id}')">Remove</button></td></tr>`).join('');
            } catch (err) { console.error(err); }
        }

        async function createAffiliate() {
            const userId = document.getElementById('affiliateUserId').value;
            const code = document.getElementById('affiliateCode').value.trim().toUpperCase();
            if (!userId || !code) { showAlert('Select user and enter code', 'error'); return; }
            try {
                await supabase.from('affiliates').insert({ user_id: userId, affiliate_code: code, commission_rate: parseFloat(document.getElementById('affiliateRate').value) / 100, payment_email: document.getElementById('affiliatePaymentEmail').value || null });
                await supabase.from('users').update({ is_affiliate: true, affiliate_code: code }).eq('id', userId);
                showAlert('Affiliate created!', 'success');
                closeModal('addAffiliateModal');
                loadAffiliates(); loadDashboard();
            } catch (err) { showAlert('Error: ' + err.message, 'error'); }
        }

        async function payAffiliate(id) {
            if (!confirm('Mark as paid?')) return;
            const a = allAffiliates.find(x => x.id === id);
            try { await supabase.from('affiliates').update({ paid_out: (a.paid_out || 0) + (a.pending_payout || 0), pending_payout: 0 }).eq('id', id); showAlert('Paid!', 'success'); loadAffiliates(); } catch (err) { showAlert('Error', 'error'); }
        }

        function processPayouts() { const pending = allAffiliates.filter(a => a.pending_payout > 0); alert(pending.length ? `${pending.length} affiliates pending. Process via PayPal/bank.` : 'No pending payouts.'); }
        async function deleteAffiliate(id) { if (!confirm('Remove?')) return; try { await supabase.from('affiliates').delete().eq('id', id); loadAffiliates(); } catch (err) {} }

        function populateDaySelector() { document.getElementById('daySelector').innerHTML = '<option value="">-- Select --</option>' + Array.from({length:30}, (_,i) => `<option value="${i+1}">Day ${i+1}</option>`).join(''); }

        async function loadDayContent() {
            const day = document.getElementById('daySelector').value;
            if (!day) { document.getElementById('contentEditor').style.display = 'none'; return; }
            document.getElementById('contentEditor').style.display = 'block';
            try {
                const { data } = await supabase.from('content_management').select('*').eq('day_number', parseInt(day)).single();
                document.getElementById('dayTitle').value = data?.title || '';
                document.getElementById('videoUrl').value = data?.video_url || '';
                document.getElementById('quizQuestions').value = data?.quiz_questions ? JSON.stringify(data.quiz_questions, null, 2) : '';
                document.getElementById('taskDescription').value = data?.task_description || '';
            } catch (err) { document.getElementById('dayTitle').value = ''; document.getElementById('videoUrl').value = ''; document.getElementById('quizQuestions').value = ''; document.getElementById('taskDescription').value = ''; }
        }

        async function saveContent() {
            const day = document.getElementById('daySelector').value;
            if (!day) { showAlert('Select a day', 'error'); return; }
            let quiz = null;
            try { const q = document.getElementById('quizQuestions').value.trim(); if (q) quiz = JSON.parse(q); } catch (e) { showAlert('Invalid JSON', 'error'); return; }
            try {
                await supabase.from('content_management').upsert({ day_number: parseInt(day), title: document.getElementById('dayTitle').value, video_url: document.getElementById('videoUrl').value, quiz_questions: quiz, task_description: document.getElementById('taskDescription').value, updated_by: currentAdmin.id, updated_at: new Date().toISOString() }, { onConflict: 'day_number' });
                showAlert('Saved!', 'success');
            } catch (err) { showAlert('Error: ' + err.message, 'error'); }
        }

        async function loadAnalytics() {
            try {
                const { data: users } = await supabase.from('users').select('*').eq('has_paid', true);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const week = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const month = new Date(now.getFullYear(), now.getMonth(), 1);
                document.getElementById('todayRevenue').textContent = '$' + (users?.filter(u => new Date(u.payment_date) >= today).reduce((s, u) => s + (u.payment_amount || 39.99), 0) || 0).toFixed(2);
                document.getElementById('weekRevenue').textContent = '$' + (users?.filter(u => new Date(u.payment_date) >= week).reduce((s, u) => s + (u.payment_amount || 39.99), 0) || 0).toFixed(2);
                document.getElementById('monthRevenue').textContent = '$' + (users?.filter(u => new Date(u.payment_date) >= month).reduce((s, u) => s + (u.payment_amount || 39.99), 0) || 0).toFixed(2);
                document.getElementById('avgOrderValue').textContent = '$' + (users?.length ? (users.reduce((s, u) => s + (u.payment_amount || 39.99), 0) / users.length).toFixed(2) : '0.00');
                createCharts(users || []);
            } catch (err) { console.error(err); }
        }

        function createCharts(users) {
            const days = Array.from({length:30}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - (29 - i)); return d.toISOString().split('T')[0]; });
            const revByDate = {}; const userByDate = {};
            days.forEach(d => { revByDate[d] = 0; userByDate[d] = 0; });
            users.forEach(u => { if (u.payment_date) { const d = u.payment_date.split('T')[0]; if (revByDate[d] !== undefined) revByDate[d] += (u.payment_amount || 39.99); } });
            allUsers.forEach(u => { if (u.created_at) { const d = u.created_at.split('T')[0]; if (userByDate[d] !== undefined) userByDate[d]++; } });
            
            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(document.getElementById('revenueChart'), { type: 'line', data: { labels: days.map(d => d.slice(5)), datasets: [{ label: 'Revenue ($)', data: days.map(d => revByDate[d]), borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } });
            
            if (usersChart) usersChart.destroy();
            usersChart = new Chart(document.getElementById('usersChart'), { type: 'bar', data: { labels: days.map(d => d.slice(5)), datasets: [{ label: 'New Users', data: days.map(d => userByDate[d]), backgroundColor: '#10b981' }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function previewEmail() { const w = window.open('', '_blank'); w.document.write(`<html><head><title>Preview</title></head><body style="font-family:Arial;padding:20px;"><h2>${document.getElementById('emailSubject').value}</h2><hr>${document.getElementById('emailContent').value}</body></html>`); }
        function sendEmail() { showAlert('Email service integration required (Resend/SendGrid)', 'info'); }

        async function loadCommunityPosts() {
            try {
                const { data } = await supabase.from('forum_posts').select('*, users:user_id (email, full_name)').order('created_at', { ascending: false });
                const tbody = document.getElementById('postsTableBody');
                if (!data?.length) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No posts</td></tr>'; return; }
                tbody.innerHTML = data.map(p => `<tr><td><strong>${p.title}</strong></td><td>${p.users?.full_name || p.users?.email || 'Unknown'}</td><td>${p.day_tag ? 'Day ' + p.day_tag : '-'}</td><td>${p.replies_count || 0}</td><td>${p.pinned ? '<span class="badge badge-info">Pinned</span>' : ''} ${p.hidden ? '<span class="badge badge-danger">Hidden</span>' : '<span class="badge badge-success">Visible</span>'}</td><td>${formatDate(p.created_at)}</td><td><button class="btn btn-sm btn-${p.pinned ? 'secondary' : 'warning'}" onclick="togglePin('${p.id}', ${!p.pinned})">${p.pinned ? 'Unpin' : 'Pin'}</button> <button class="btn btn-sm btn-${p.hidden ? 'success' : 'danger'}" onclick="toggleHide('${p.id}', ${!p.hidden})">${p.hidden ? 'Show' : 'Hide'}</button></td></tr>`).join('');
            } catch (err) { console.error(err); }
        }

        async function togglePin(id, state) { try { await supabase.from('forum_posts').update({ pinned: state }).eq('id', id); loadCommunityPosts(); } catch (err) {} }
        async function toggleHide(id, state) { try { await supabase.from('forum_posts').update({ hidden: state }).eq('id', id); loadCommunityPosts(); } catch (err) {} }

        async function loadLiveFeed() {
            try {
                const { data } = await supabase.from('live_feed').select('*').order('created_at', { ascending: false }).limit(20);
                const container = document.getElementById('feedList');
                if (!data?.length) { container.innerHTML = '<div class="empty-state">No announcements</div>'; return; }
                container.innerHTML = data.map(f => `<div style="background:${f.is_active ? '#f8fafc' : '#fee2e2'};padding:15px;border-radius:10px;margin-bottom:10px;"><div style="display:flex;justify-content:space-between;align-items:start;"><div><span class="badge badge-info">${f.type}</span><p style="margin-top:10px;">${f.message}</p><small style="color:#64748b;">${formatDate(f.created_at)}</small></div><div><button class="btn btn-sm btn-${f.is_active ? 'danger' : 'success'}" onclick="toggleFeed('${f.id}', ${!f.is_active})">${f.is_active ? 'Disable' : 'Enable'}</button> <button class="btn btn-sm btn-secondary" onclick="deleteFeed('${f.id}')">Delete</button></div></div></div>`).join('');
            } catch (err) { console.error(err); }
        }

        async function postToFeed() {
            const msg = document.getElementById('feedMessage').value.trim();
            if (!msg) { showAlert('Enter message', 'error'); return; }
            try {
                await supabase.from('live_feed').insert({ message: msg, type: document.getElementById('feedType').value, created_by: currentAdmin.id, expires_at: document.getElementById('feedExpires').value || null });
                showAlert('Posted!', 'success');
                document.getElementById('feedMessage').value = '';
                loadLiveFeed();
            } catch (err) { showAlert('Error', 'error'); }
        }

        async function toggleFeed(id, state) { try { await supabase.from('live_feed').update({ is_active: state }).eq('id', id); loadLiveFeed(); } catch (err) {} }
        async function deleteFeed(id) { if (!confirm('Delete?')) return; try { await supabase.from('live_feed').delete().eq('id', id); loadLiveFeed(); } catch (err) {} }

        async function loadCertificates() {
            try {
                const { data } = await supabase.from('certificates').select('*, users:user_id (email, full_name)').order('issued_at', { ascending: false });
                const tbody = document.getElementById('certificatesTableBody');
                if (!data?.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No certificates</td></tr>'; return; }
                tbody.innerHTML = data.map(c => `<tr><td><strong>${c.full_name}</strong></td><td><code>${c.certificate_id}</code></td><td>${c.final_score}%</td><td>${formatDate(c.issued_at)}</td><td><span class="badge badge-${c.revoked ? 'danger' : 'success'}">${c.revoked ? 'Revoked' : 'Valid'}</span></td><td><button class="btn btn-sm btn-primary" onclick="window.open('/certificate.html?id=${c.certificate_id}')">View</button> <button class="btn btn-sm btn-${c.revoked ? 'success' : 'danger'}" onclick="toggleRevoke('${c.id}', ${!c.revoked})">${c.revoked ? 'Restore' : 'Revoke'}</button></td></tr>`).join('');
            } catch (err) { console.error(err); }
        }

        async function createCertificate() {
            const name = document.getElementById('certName').value.trim();
            const score = parseInt(document.getElementById('certScore').value);
            if (!name || !score) { showAlert('Enter name and score', 'error'); return; }
            const certId = 'MW-' + new Date().getFullYear() + '-' + Math.random().toString(36).substring(2, 8).toUpperCase();
            try {
                await supabase.from('certificates').insert({ user_id: document.getElementById('certUserId').value || null, certificate_id: certId, full_name: name, final_score: score });
                showAlert('Created! ID: ' + certId, 'success');
                closeModal('createCertModal');
                loadCertificates();
            } catch (err) { showAlert('Error', 'error'); }
        }

        async function toggleRevoke(id, state) { try { await supabase.from('certificates').update({ revoked: state }).eq('id', id); loadCertificates(); } catch (err) {} }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showAlert(msg, type) {
            const div = document.createElement('div');
            div.className = `alert alert-${type}`;
            div.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span><span>${msg}</span>`;
            document.getElementById('alertContainer').appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }
        function formatDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }

        document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }));
        document.addEventListener('DOMContentLoaded', checkSession);
    </script>
</body>
</html>
