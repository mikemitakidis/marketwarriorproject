<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Flow - Market Warrior</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e293b;
            color: white;
            padding: 40px;
            line-height: 1.6;
        }
        h1 { color: #667eea; margin-bottom: 30px; }
        h2 { color: #94a3b8; margin: 30px 0 15px; font-size: 1.2em; }
        .test-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .test-item:last-child { border-bottom: none; }
        .test-status {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
        .test-status.pass { background: #10b981; }
        .test-status.fail { background: #ef4444; }
        .test-status.pending { background: #f59e0b; }
        .test-name { flex: 1; }
        .test-result { color: #94a3b8; font-size: 0.9em; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        button:hover { background: #5a6fd8; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .log {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry { padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-entry.error { color: #ef4444; }
        .log-entry.success { color: #10b981; }
        .log-entry.info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Market Warrior - System Test</h1>
    <p style="color: #94a3b8; margin-bottom: 30px;">This page tests all critical functionality of the platform.</p>

    <button onclick="runAllTests()">â–¶ Run All Tests</button>
    <button onclick="clearLog()">ðŸ—‘ Clear Log</button>
    <button onclick="window.location.href='/dashboard'">ðŸ“Š Go to Dashboard</button>

    <h2>Authentication Tests</h2>
    <div class="test-section" id="authTests">
        <div class="test-item" id="test-session">
            <div class="test-status pending">?</div>
            <div class="test-name">Check Session</div>
            <div class="test-result">-</div>
        </div>
        <div class="test-item" id="test-user-data">
            <div class="test-status pending">?</div>
            <div class="test-name">Load User Data</div>
            <div class="test-result">-</div>
        </div>
    </div>

    <h2>API Tests</h2>
    <div class="test-section" id="apiTests">
        <div class="test-item" id="test-day-api">
            <div class="test-status pending">?</div>
            <div class="test-name">Day Content API (/api/day/1)</div>
            <div class="test-result">-</div>
        </div>
        <div class="test-item" id="test-quiz-api">
            <div class="test-status pending">?</div>
            <div class="test-name">Quiz Validation API</div>
            <div class="test-result">-</div>
        </div>
        <div class="test-item" id="test-promo-api">
            <div class="test-status pending">?</div>
            <div class="test-name">Promo Code API</div>
            <div class="test-result">-</div>
        </div>
    </div>

    <h2>Database Tests</h2>
    <div class="test-section" id="dbTests">
        <div class="test-item" id="test-users-table">
            <div class="test-status pending">?</div>
            <div class="test-name">Users Table Access</div>
            <div class="test-result">-</div>
        </div>
        <div class="test-item" id="test-progress-table">
            <div class="test-status pending">?</div>
            <div class="test-name">Progress Table Access</div>
            <div class="test-result">-</div>
        </div>
    </div>

    <h2>Page Navigation Tests</h2>
    <div class="test-section" id="pageTests">
        <div class="test-item" id="test-pages">
            <div class="test-status pending">?</div>
            <div class="test-name">All Pages Exist</div>
            <div class="test-result">-</div>
        </div>
    </div>

    <h2>Test Log</h2>
    <div class="log" id="testLog">
        <div class="log-entry info">Ready to run tests...</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gvpaemdpmwyncdztlczy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cGFlbWRwbXd5bmNkenRsY3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM0MzQxNzUsImV4cCI6MjA0OTAxMDE3NX0.yrXU7tPwBSKnFP2NiT8uBzPdlmWNJMrhGv-PnE0PsKU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let accessToken = null;
        let currentUser = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '<div class="log-entry info">Log cleared...</div>';
        }

        function setTestResult(testId, passed, result) {
            const testItem = document.getElementById(testId);
            const status = testItem.querySelector('.test-status');
            const resultDiv = testItem.querySelector('.test-result');
            
            status.className = `test-status ${passed ? 'pass' : 'fail'}`;
            status.textContent = passed ? 'âœ“' : 'âœ—';
            resultDiv.textContent = result;
        }

        async function runAllTests() {
            log('Starting comprehensive tests...', 'info');
            
            // Test 1: Session
            await testSession();
            
            // Test 2: User Data
            await testUserData();
            
            // Test 3: Day API
            await testDayAPI();
            
            // Test 4: Quiz API
            await testQuizAPI();
            
            // Test 5: Promo API
            await testPromoAPI();
            
            // Test 6: Users Table
            await testUsersTable();
            
            // Test 7: Progress Table
            await testProgressTable();
            
            // Test 8: Pages
            await testPages();
            
            log('All tests completed!', 'success');
        }

        async function testSession() {
            try {
                log('Testing session...', 'info');
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (session) {
                    accessToken = session.access_token;
                    currentUser = session.user;
                    setTestResult('test-session', true, `Logged in as ${session.user.email}`);
                    log(`Session found: ${session.user.email}`, 'success');
                } else {
                    setTestResult('test-session', false, 'Not logged in');
                    log('No active session. Please log in first.', 'error');
                }
            } catch (error) {
                setTestResult('test-session', false, error.message);
                log(`Session error: ${error.message}`, 'error');
            }
        }

        async function testUserData() {
            if (!currentUser) {
                setTestResult('test-user-data', false, 'No session');
                return;
            }
            
            try {
                log('Testing user data fetch...', 'info');
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (data) {
                    setTestResult('test-user-data', true, `Name: ${data.full_name || 'Not set'}`);
                    log(`User data loaded: ${data.full_name}`, 'success');
                } else {
                    setTestResult('test-user-data', false, error?.message || 'No data');
                    log(`User data error: ${error?.message}`, 'error');
                }
            } catch (error) {
                setTestResult('test-user-data', false, error.message);
                log(`User data error: ${error.message}`, 'error');
            }
        }

        async function testDayAPI() {
            if (!accessToken) {
                setTestResult('test-day-api', false, 'No token');
                return;
            }
            
            try {
                log('Testing Day API...', 'info');
                const response = await fetch('/api/day/1', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    setTestResult('test-day-api', true, `Day 1: ${data.day.title}`);
                    log(`Day API works: ${data.day.title}`, 'success');
                } else {
                    setTestResult('test-day-api', false, data.error || 'Failed');
                    log(`Day API error: ${data.error}`, 'error');
                }
            } catch (error) {
                setTestResult('test-day-api', false, error.message);
                log(`Day API error: ${error.message}`, 'error');
            }
        }

        async function testQuizAPI() {
            if (!accessToken || !currentUser) {
                setTestResult('test-quiz-api', false, 'No token/user');
                return;
            }
            
            try {
                log('Testing Quiz API...', 'info');
                const response = await fetch('/api/quiz/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        day_number: 1,
                        user_answers: ['b', 'c', 'b', 'b', 'c'],
                        user_id: currentUser.id
                    })
                });
                const data = await response.json();
                
                if (data.success !== undefined) {
                    setTestResult('test-quiz-api', true, `Score: ${data.score}/${data.total}`);
                    log(`Quiz API works: ${data.score}/${data.total} (${data.percentage}%)`, 'success');
                } else {
                    setTestResult('test-quiz-api', false, data.error || 'Failed');
                    log(`Quiz API error: ${data.error}`, 'error');
                }
            } catch (error) {
                setTestResult('test-quiz-api', false, error.message);
                log(`Quiz API error: ${error.message}`, 'error');
            }
        }

        async function testPromoAPI() {
            try {
                log('Testing Promo API...', 'info');
                const response = await fetch('/api/promo/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: 'TESTCODE' })
                });
                const data = await response.json();
                
                // Either valid or invalid response is OK - API works
                setTestResult('test-promo-api', true, data.valid ? `Valid: ${data.discount_percent}%` : 'Invalid code (expected)');
                log(`Promo API works: ${data.valid ? 'Valid code' : 'Invalid code (expected)'}`, 'success');
            } catch (error) {
                setTestResult('test-promo-api', false, error.message);
                log(`Promo API error: ${error.message}`, 'error');
            }
        }

        async function testUsersTable() {
            try {
                log('Testing users table...', 'info');
                const { data, error, count } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                
                if (!error) {
                    setTestResult('test-users-table', true, `Accessible (${count} users)`);
                    log(`Users table accessible: ${count} records`, 'success');
                } else {
                    setTestResult('test-users-table', false, error.message);
                    log(`Users table error: ${error.message}`, 'error');
                }
            } catch (error) {
                setTestResult('test-users-table', false, error.message);
                log(`Users table error: ${error.message}`, 'error');
            }
        }

        async function testProgressTable() {
            try {
                log('Testing progress table...', 'info');
                const { data, error, count } = await supabase
                    .from('challenge_progress')
                    .select('*', { count: 'exact', head: true });
                
                if (!error) {
                    setTestResult('test-progress-table', true, `Accessible (${count} records)`);
                    log(`Progress table accessible: ${count} records`, 'success');
                } else {
                    setTestResult('test-progress-table', false, error.message);
                    log(`Progress table error: ${error.message}`, 'error');
                }
            } catch (error) {
                setTestResult('test-progress-table', false, error.message);
                log(`Progress table error: ${error.message}`, 'error');
            }
        }

        async function testPages() {
            const pages = ['/', '/login', '/signup', '/welcome', '/dashboard', '/day?day=1', '/admin', '/terms', '/privacy'];
            let allExist = true;
            let results = [];
            
            log('Testing page accessibility...', 'info');
            
            for (const page of pages) {
                try {
                    const response = await fetch(page, { method: 'HEAD' });
                    if (response.ok || response.status === 302) {
                        results.push(`âœ“ ${page}`);
                        log(`Page ${page}: OK`, 'success');
                    } else {
                        results.push(`âœ— ${page}`);
                        allExist = false;
                        log(`Page ${page}: ${response.status}`, 'error');
                    }
                } catch (e) {
                    results.push(`âœ— ${page}`);
                    allExist = false;
                    log(`Page ${page}: Error`, 'error');
                }
            }
            
            setTestResult('test-pages', allExist, allExist ? 'All pages OK' : 'Some pages missing');
        }

        // Auto-run session check on load
        document.addEventListener('DOMContentLoaded', () => {
            testSession();
        });
    </script>
</body>
</html>
