<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day Loading... - Market Warrior</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        body { font-family: 'Segoe UI', sans-serif; line-height: 1.6; background: #f5f7fa; color: #1e293b; }
        .site-header { background: linear-gradient(135deg, #667eea, #764ba2); padding: 15px 20px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-left a { display: flex; align-items: center; gap: 10px; color: white; text-decoration: none; }
        .header-left img { width: 40px; height: 40px; border-radius: 8px; }
        .header-left h1 { font-size: 1.3em; }
        .btn-dashboard { background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s; }
        .btn-dashboard:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .day-header { background: white; padding: 40px; text-align: center; border-radius: 20px; margin-bottom: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .day-badge { display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 25px; border-radius: 30px; font-weight: bold; margin-bottom: 20px; }
        .day-header h1 { font-size: 2.2em; margin-bottom: 10px; }
        .day-header p { color: #64748b; font-size: 1.1em; }
        .section { background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .section h2 { font-size: 1.4em; margin-bottom: 20px; }
        .quiz-section { background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .quiz-progress { display: flex; justify-content: space-between; margin-bottom: 20px; color: #64748b; }
        .question-container { margin-bottom: 20px; }
        .question-number { width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 15px; }
        .question-text { font-size: 1.1em; font-weight: 600; margin-bottom: 20px; }
        .quiz-options { display: flex; flex-direction: column; gap: 12px; }
        .quiz-option { display: flex; align-items: center; gap: 15px; padding: 15px 20px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: all 0.3s; }
        .quiz-option:hover { border-color: #667eea; background: #f8fafc; }
        .quiz-option.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); }
        .quiz-option.correct { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .quiz-option.incorrect { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .option-letter { width: 35px; height: 35px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #64748b; }
        .quiz-option.selected .option-letter { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-quiz { padding: 15px 30px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 20px; }
        .btn-quiz.primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-quiz:hover { transform: translateY(-2px); }
        .btn-quiz:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .quiz-results { text-align: center; padding: 40px; display: none; }
        .quiz-results.show { display: block; }
        .score-circle { width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .score-value { font-size: 2.5em; font-weight: bold; }
        .quiz-results.failed .score-circle { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .feedback-item { text-align: left; padding: 15px; margin: 10px 0; border-radius: 10px; background: #f8fafc; }
        .feedback-item.correct { border-left: 4px solid #10b981; }
        .feedback-item.incorrect { border-left: 4px solid #ef4444; }
        .feedback-explanation { margin-top: 10px; font-size: 0.9em; color: #64748b; }
        .task-section { background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .task-steps { list-style: none; counter-reset: step; }
        .task-steps li { counter-increment: step; padding: 15px 15px 15px 60px; position: relative; border-bottom: 1px solid #e2e8f0; }
        .task-steps li::before { content: counter(step); position: absolute; left: 15px; width: 30px; height: 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .upload-area { border: 2px dashed #cbd5e1; border-radius: 15px; padding: 30px; text-align: center; margin-top: 20px; transition: all 0.3s; }
        .upload-area:hover { border-color: #667eea; background: #f8fafc; }
        .btn-submit { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px 40px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin-top: 20px; transition: all 0.3s; }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { text-align: center; padding: 60px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 15px; margin-bottom: 20px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .day-nav { display: flex; justify-content: space-between; margin-top: 30px; }
        .nav-btn { padding: 15px 25px; border-radius: 10px; text-decoration: none; font-weight: 600; transition: all 0.3s; }
        .nav-btn.prev { background: #e2e8f0; color: #64748b; }
        .nav-btn.next { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .nav-btn.disabled { opacity: 0.5; pointer-events: none; }
        .locked-overlay { text-align: center; padding: 60px 20px; }
        .locked-icon { font-size: 4em; margin-bottom: 20px; }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-left">
            <a href="/dashboard.html"><img src="/logo.png" alt="Market Warrior"><h1>Market Warrior</h1></a>
        </div>
        <div class="header-right">
            <a href="/dashboard.html" class="btn-dashboard">‚Üê Back to Dashboard</a>
        </div>
    </header>
    <div class="container">
        <div id="loadingState" class="loading"><div class="spinner"></div><p>Loading day content...</p></div>
        <div id="errorState" style="display: none;">
            <div class="error-message"><h3>‚ö†Ô∏è Access Denied</h3><p id="errorMessage">Unable to load content.</p><a href="/dashboard.html" class="btn-dashboard" style="display: inline-block; margin-top: 20px;">Return to Dashboard</a></div>
        </div>
        <div id="lockedState" style="display: none;">
            <div class="section locked-overlay"><div class="locked-icon">üîí</div><h2>Day <span id="lockedDay">X</span> is Locked</h2><p id="lockedMessage">Complete previous days to unlock.</p><p id="unlockTime" style="margin-top: 20px; color: #64748b;"></p><a href="/dashboard.html" class="btn-dashboard" style="display: inline-block; margin-top: 20px;">Return to Dashboard</a></div>
        </div>
        <div id="contentState" style="display: none;">
            <div class="day-header"><div class="day-badge" id="dayBadge">Day 1 of 30</div><h1 id="dayTitle">Loading...</h1><p id="daySubtitle">Loading...</p></div>
            <div class="section" id="videoSection" style="display: none;"><h2>üì∫ Today's Video Lesson</h2><div class="video-container"><iframe id="videoFrame" src="" frameborder="0" allowfullscreen></iframe></div></div>
            <div class="section"><h2>üìö Today's Lesson</h2><div id="contentContainer"></div></div>
            <div class="quiz-section" id="quizSection">
                <h2>üìù Knowledge Check</h2>
                <div class="quiz-progress"><span>Question <span id="currentQuestion">1</span> of <span id="totalQuestions">5</span></span></div>
                <div id="quizContainer"></div>
                <div class="quiz-results" id="quizResults"><h3 id="resultsTitle">Quiz Results</h3><div class="score-circle"><span class="score-value" id="scoreValue">0%</span></div><p id="resultsMessage"></p><div id="feedbackContainer"></div><button class="btn-quiz primary" onclick="retryQuiz()" id="retryBtn" style="display: none;">Retry Quiz</button></div>
            </div>
            <div class="task-section" id="taskSection">
                <h2>‚úÖ Today's Task</h2><p id="taskDescription"></p><ol class="task-steps" id="taskSteps"></ol>
                <div class="upload-area"><p>üì∏ Upload your screenshot or evidence</p><input type="file" id="taskFile" accept="image/*" style="margin-top: 15px;"><div id="uploadPreview" style="margin-top: 15px; display: none;"><img id="previewImage" style="max-width: 300px; border-radius: 10px;"></div></div>
                <button class="btn-submit" id="submitTaskBtn" onclick="submitTask()" disabled>Submit Task & Complete Day</button>
            </div>
            <div class="day-nav"><a href="#" class="nav-btn prev" id="prevDayBtn">‚Üê Previous Day</a><a href="#" class="nav-btn next" id="nextDayBtn">Next Day ‚Üí</a></div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://gvpaemdpmwyncdztlczy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cGFlbWRwbXd5bmNkenRsY3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MDY1NTAsImV4cCI6MjA4MDk4MjU1MH0.kg6mlLcHv3APGnIeE7vRJpzF1u8JUyGKsYthXQXEAAE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let dayNumber = 1, accessToken = null, currentUser = null;
        let quizQuestions = [], userAnswers = [], currentQuestionIndex = 0;
        let quizSubmitted = false, quizPassed = false, taskCompleted = false;
        
        const urlParams = new URLSearchParams(window.location.search);
        const pathDay = window.location.pathname.match(/day[\/=]?(\d+)/i);
        dayNumber = parseInt(urlParams.get('day') || (pathDay ? pathDay[1] : 1)) || 1;
        
        async function init() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) { window.location.href = '/login.html'; return; }
                accessToken = session.access_token;
                currentUser = session.user;
                await loadDayContent();
            } catch (error) {
                console.error('Init error:', error);
                showError('Failed to initialize. Please refresh.');
            }
        }
        
        async function loadDayContent() {
            try {
                const response = await fetch(`/api/day/${dayNumber}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (!response.ok) {
                    if (data.code === 'DAY_LOCKED') { showLocked(data.error, data.unlockAt); return; }
                    if (data.code === 'PAYMENT_REQUIRED') { window.location.href = '/login.html?payment=required'; return; }
                    if (data.code === 'TERMS_NOT_ACCEPTED') { window.location.href = '/welcome.html'; return; }
                    showError(data.error || 'Failed to load content'); return;
                }
                renderContent(data);
            } catch (error) {
                console.error('Load error:', error);
                showError('Failed to load content.');
            }
        }
        
        function showLocked(message, unlockAt) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('lockedState').style.display = 'block';
            document.getElementById('lockedDay').textContent = dayNumber;
            document.getElementById('lockedMessage').textContent = message;
            if (unlockAt) {
                const date = new Date(unlockAt);
                document.getElementById('unlockTime').textContent = `Unlocks: ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
            }
        }
        
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        function renderContent(data) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentState').style.display = 'block';
            document.title = `Day ${dayNumber} - Market Warrior`;
            document.getElementById('dayBadge').textContent = `Day ${dayNumber} of 30`;
            document.getElementById('dayTitle').textContent = data.content.title || `Day ${dayNumber}`;
            document.getElementById('daySubtitle').textContent = data.content.subtitle || '';
            
            if (data.content.youtubeId) {
                document.getElementById('videoSection').style.display = 'block';
                document.getElementById('videoFrame').src = `https://www.youtube.com/embed/${data.content.youtubeId}`;
            }
            if (data.content.html) document.getElementById('contentContainer').innerHTML = data.content.html;
            
            quizQuestions = data.quiz || [];
            if (quizQuestions.length > 0) {
                document.getElementById('totalQuestions').textContent = quizQuestions.length;
                if (data.progress?.quizPassed) { quizPassed = true; quizSubmitted = true; showQuizPassed(data.progress.quizScore); }
                else renderQuiz();
            }
            
            if (data.content.task) {
                document.getElementById('taskDescription').textContent = data.content.task.description || '';
                const stepsContainer = document.getElementById('taskSteps');
                stepsContainer.innerHTML = '';
                (data.content.task.steps || []).forEach(step => { const li = document.createElement('li'); li.textContent = step; stepsContainer.appendChild(li); });
            }
            
            if (data.progress?.taskCompleted) { taskCompleted = true; document.getElementById('submitTaskBtn').textContent = '‚úì Task Completed'; document.getElementById('submitTaskBtn').disabled = true; }
            updateNavigation();
        }
        
        function updateNavigation() {
            const prevBtn = document.getElementById('prevDayBtn');
            const nextBtn = document.getElementById('nextDayBtn');
            if (dayNumber > 1) { prevBtn.href = `/day.html?day=${dayNumber - 1}`; prevBtn.classList.remove('disabled'); }
            else prevBtn.classList.add('disabled');
            if (dayNumber < 30 && quizPassed && taskCompleted) { nextBtn.href = `/day.html?day=${dayNumber + 1}`; nextBtn.classList.remove('disabled'); }
            else if (dayNumber === 30 && quizPassed && taskCompleted) { nextBtn.href = '/certificate.html'; nextBtn.textContent = 'Get Certificate ‚Üí'; nextBtn.classList.remove('disabled'); }
            else nextBtn.classList.add('disabled');
        }
        
        function renderQuiz() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = '';
            quizQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.id = `question-${index}`;
                questionDiv.style.display = index === 0 ? 'block' : 'none';
                const opts = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
                questionDiv.innerHTML = `<div class="question-number">${index + 1}</div><div class="question-text">${q.question}</div><div class="quiz-options">${opts.map((opt, i) => `<div class="quiz-option" onclick="selectOption(${index}, ${i})"><div class="option-letter">${['A','B','C','D'][i]}</div><span>${opt}</span></div>`).join('')}</div>`;
                container.appendChild(questionDiv);
            });
            const submitBtn = document.createElement('button');
            submitBtn.className = 'btn-quiz primary';
            submitBtn.id = 'quizSubmitBtn';
            submitBtn.textContent = 'Next Question';
            submitBtn.onclick = nextQuestion;
            submitBtn.disabled = true;
            container.appendChild(submitBtn);
        }
        
        function selectOption(questionIndex, optionIndex) {
            userAnswers[questionIndex] = optionIndex;
            const options = document.querySelectorAll(`#question-${questionIndex} .quiz-option`);
            options.forEach((opt, i) => { opt.classList.remove('selected'); if (i === optionIndex) opt.classList.add('selected'); });
            document.getElementById('quizSubmitBtn').disabled = false;
        }
        
        function nextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                document.getElementById(`question-${currentQuestionIndex}`).style.display = 'none';
                currentQuestionIndex++;
                document.getElementById(`question-${currentQuestionIndex}`).style.display = 'block';
                document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
                document.getElementById('quizSubmitBtn').disabled = true;
                if (currentQuestionIndex === quizQuestions.length - 1) document.getElementById('quizSubmitBtn').textContent = 'Submit Quiz';
            } else submitQuiz();
        }
        
        async function submitQuiz() {
            const btn = document.getElementById('quizSubmitBtn');
            btn.disabled = true; btn.textContent = 'Submitting...';
            try {
                const response = await fetch('/api/quiz/submit', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dayNumber: dayNumber, answers: userAnswers })
                });
                const result = await response.json();
                if (!response.ok) { alert(result.error || 'Failed'); btn.disabled = false; btn.textContent = 'Submit Quiz'; return; }
                quizSubmitted = true; quizPassed = result.passed;
                showQuizResults(result);
            } catch (error) {
                console.error('Quiz error:', error);
                alert('Failed to submit quiz.');
                btn.disabled = false; btn.textContent = 'Submit Quiz';
            }
        }
        
        function showQuizResults(result) {
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('quizResults').classList.add('show');
            document.getElementById('scoreValue').textContent = result.score + '%';
            if (result.passed) {
                document.getElementById('quizResults').classList.remove('failed');
                document.getElementById('resultsTitle').textContent = 'üéâ Quiz Passed!';
                document.getElementById('resultsMessage').textContent = result.message;
                document.getElementById('retryBtn').style.display = 'none';
                document.getElementById('submitTaskBtn').disabled = false;
            } else {
                document.getElementById('quizResults').classList.add('failed');
                document.getElementById('resultsTitle').textContent = '‚ùå Quiz Not Passed';
                document.getElementById('resultsMessage').textContent = result.message;
                document.getElementById('retryBtn').style.display = 'inline-block';
            }
            if (result.feedback) {
                const feedbackContainer = document.getElementById('feedbackContainer');
                feedbackContainer.innerHTML = '<h4 style="margin-top: 20px;">Review:</h4>';
                result.feedback.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = `feedback-item ${item.wasCorrect ? 'correct' : 'incorrect'}`;
                    const opts = typeof quizQuestions[i].options === 'string' ? JSON.parse(quizQuestions[i].options) : quizQuestions[i].options;
                    div.innerHTML = `<strong>Q${i+1}: ${quizQuestions[i].question}</strong><p>Your answer: ${opts[item.userAnswer] || 'Not answered'}</p>${!item.wasCorrect ? `<p style="color: #10b981;">Correct: ${opts[item.correctAnswer]}</p>` : ''}<p class="feedback-explanation">${item.explanation || ''}</p>`;
                    feedbackContainer.appendChild(div);
                });
            }
            updateNavigation();
        }
        
        function showQuizPassed(score) {
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('quizResults').classList.add('show');
            document.getElementById('quizResults').classList.remove('failed');
            document.getElementById('resultsTitle').textContent = '‚úì Quiz Already Passed';
            document.getElementById('scoreValue').textContent = (score || 100) + '%';
            document.getElementById('resultsMessage').textContent = 'You have already passed this quiz.';
            document.getElementById('retryBtn').style.display = 'none';
            document.getElementById('submitTaskBtn').disabled = false;
        }
        
        function retryQuiz() {
            currentQuestionIndex = 0; userAnswers = []; quizSubmitted = false;
            document.getElementById('quizResults').classList.remove('show');
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('currentQuestion').textContent = '1';
            document.getElementById('quizSubmitBtn').textContent = 'Next Question';
            document.getElementById('quizSubmitBtn').disabled = true;
            document.getElementById('feedbackContainer').innerHTML = '';
            document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('.question-container').forEach((q, i) => q.style.display = i === 0 ? 'block' : 'none');
        }
        
        document.getElementById('taskFile').addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { document.getElementById('previewImage').src = e.target.result; document.getElementById('uploadPreview').style.display = 'block'; };
                reader.readAsDataURL(this.files[0]);
            }
        });
        
        async function submitTask() {
            if (!quizPassed) { alert('Please pass the quiz first!'); return; }
            const fileInput = document.getElementById('taskFile');
            const btn = document.getElementById('submitTaskBtn');
            btn.disabled = true; btn.textContent = 'Submitting...';
            try {
                let fileUrl = null;
                if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const fileName = `${currentUser.id}/day${dayNumber}_${Date.now()}.${file.name.split('.').pop()}`;
                    const { error: uploadError } = await supabase.storage.from('task-screenshots').upload(fileName, file);
                    if (!uploadError) {
                        const { data: { publicUrl } } = supabase.storage.from('task-screenshots').getPublicUrl(fileName);
                        fileUrl = publicUrl;
                    }
                }
                const response = await fetch('/api/task/submit', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dayNumber: dayNumber, fileUrl: fileUrl })
                });
                const result = await response.json();
                if (!response.ok) { alert(result.error || 'Failed'); btn.disabled = false; btn.textContent = 'Submit Task & Complete Day'; return; }
                taskCompleted = true; btn.textContent = '‚úì Day Completed!';
                if (result.courseCompleted) { alert('üéâ Congratulations! You completed the 30-day challenge!'); window.location.href = '/certificate.html'; }
                else { alert(result.message); updateNavigation(); }
            } catch (error) {
                console.error('Task error:', error);
                alert('Failed to submit task.');
                btn.disabled = false; btn.textContent = 'Submit Task & Complete Day';
            }
        }
        
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => { if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) e.preventDefault(); });
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
