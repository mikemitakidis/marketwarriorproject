<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Market Warrior</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #f1f5f9;
        }

        /* Header */
        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            font-size: 2em;
        }

        .logo h1 {
            font-size: 1.4em;
            color: white;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: white;
        }

        .user-status {
            font-size: 0.8em;
            color: #10b981;
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1em;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .btn-logout {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px;
        }

        /* Welcome Section */
        .welcome-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .welcome-content {
            position: relative;
            z-index: 1;
        }

        .welcome-section h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .welcome-section p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .challenge-timer {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
        }

        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Action Cards */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: inherit;
        }

        .action-card:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-5px);
            border-color: #667eea;
        }

        .action-card.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
        }

        .action-card.primary:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .action-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .action-card h3 {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: white;
        }

        .action-card p {
            font-size: 0.85em;
            color: #94a3b8;
        }

        .action-card.primary p {
            color: rgba(255,255,255,0.8);
        }

        /* Progress Section */
        .progress-section {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .progress-header h2 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-percentage {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
        }

        .overall-progress {
            margin-bottom: 30px;
        }

        .progress-bar-container {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            height: 24px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            border-radius: 12px;
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            font-weight: 700;
            font-size: 0.85em;
            min-width: 60px;
        }

        /* Days Grid */
        .days-section h3 {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .phase-badge {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
        }

        .day-circle {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            margin: 0 auto;
            text-decoration: none;
            color: inherit;
        }

        .day-circle:hover:not(.locked) {
            transform: scale(1.1);
        }

        .day-circle.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .day-circle.current {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 5px 30px rgba(102, 126, 234, 0.6); }
        }

        .day-circle.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .day-number {
            font-weight: 700;
            font-size: 1.1em;
        }

        .day-status {
            font-size: 0.7em;
            margin-top: 2px;
        }

        /* Announcements Section */
        .announcements-section {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
        }

        .announcements-section h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .announcement-item {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .announcement-item:last-child {
            margin-bottom: 0;
        }

        .announcement-date {
            font-size: 0.8em;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .announcement-text {
            color: #e2e8f0;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .container {
                padding: 80px 15px 30px;
            }

            .welcome-section {
                padding: 25px;
            }

            .welcome-section h2 {
                font-size: 1.5em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .days-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            .day-circle {
                width: 55px;
                height: 55px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <a href="/dashboard" class="logo">
            <span class="logo-icon">‚öîÔ∏è</span>
            <h1>Market Warrior</h1>
        </a>
        <div class="header-right">
            <div class="user-info">
                <div class="user-details">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-status">üü¢ Active Warrior</div>
                </div>
                <div class="user-avatar" id="userAvatar">?</div>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <div class="welcome-content">
                <h2>Welcome back, <span id="welcomeName">Warrior</span>! ‚öîÔ∏è</h2>
                <p>Your trading journey continues. Keep pushing forward!</p>
                <div class="challenge-timer">
                    <span>üìÖ</span>
                    <span id="challengeDay">Day 1 of 30</span>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-value" id="completedDays">0</div>
                <div class="stat-label">Days Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="quizzesPassed">0</div>
                <div class="stat-label">Quizzes Passed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-value" id="tasksCompleted">0</div>
                <div class="stat-label">Tasks Submitted</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-value" id="avgScore">0%</div>
                <div class="stat-label">Avg Quiz Score</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="actions-grid">
            <a href="#" class="action-card primary" id="continueBtn">
                <div class="action-icon">‚ñ∂Ô∏è</div>
                <h3>Continue Learning</h3>
                <p id="continueText">Start Day 1</p>
            </a>
            <a href="/journal" class="action-card">
                <div class="action-icon">üìì</div>
                <h3>Trading Journal</h3>
                <p>Track your trades</p>
            </a>
            <a href="#progress-section" class="action-card">
                <div class="action-icon">üìä</div>
                <h3>View Progress</h3>
                <p>See your journey</p>
            </a>
            <a href="/certificate" class="action-card" id="certificateBtn" style="display: none;">
                <div class="action-icon">üéì</div>
                <h3>Certificate</h3>
                <p>Download your achievement</p>
            </a>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progress-section">
            <div class="progress-header">
                <h2>üìà Your Progress</h2>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            
            <div class="overall-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%;">0%</div>
                </div>
            </div>

            <!-- Phase 1: Foundation (Days 1-7) -->
            <div class="days-section">
                <h3>üéØ Phase 1: Foundation <span class="phase-badge">Days 1-7</span></h3>
                <div class="days-grid" id="phase1Days"></div>
            </div>

            <!-- Phase 2: Technical Analysis (Days 8-14) -->
            <div class="days-section">
                <h3>üìä Phase 2: Technical Analysis <span class="phase-badge">Days 8-14</span></h3>
                <div class="days-grid" id="phase2Days"></div>
            </div>

            <!-- Phase 3: Advanced Strategies (Days 15-21) -->
            <div class="days-section">
                <h3>üöÄ Phase 3: Advanced Strategies <span class="phase-badge">Days 15-21</span></h3>
                <div class="days-grid" id="phase3Days"></div>
            </div>

            <!-- Phase 4: Specialization (Days 22-28) -->
            <div class="days-section">
                <h3>üíé Phase 4: Specialization <span class="phase-badge">Days 22-28</span></h3>
                <div class="days-grid" id="phase4Days"></div>
            </div>

            <!-- Phase 5: Mastery (Days 29-30) -->
            <div class="days-section">
                <h3>üèÜ Phase 5: Mastery & Graduation <span class="phase-badge">Days 29-30</span></h3>
                <div class="days-grid" id="phase5Days"></div>
            </div>
        </div>

        <!-- Announcements -->
        <div class="announcements-section">
            <h2>üì¢ Announcements</h2>
            <div id="announcementsList">
                <div class="announcement-item">
                    <div class="announcement-date">Welcome!</div>
                    <div class="announcement-text">Welcome to the Market Warrior 30-Day Trading Challenge! Complete each day's lesson, quiz, and task to progress.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://gvpaemdpmwyncdztlczy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cGFlbWRwbXd5bmNkenRsY3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM0MzQxNzUsImV4cCI6MjA0OTAxMDE3NX0.yrXU7tPwBSKnFP2NiT8uBzPdlmWNJMrhGv-PnE0PsKU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentUser = null;
        let userData = null;
        let progressData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                // Check authentication
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = '/login';
                    return;
                }

                currentUser = session.user;

                // Load user data
                await loadUserData();

                // Load progress
                await loadProgress();

                // Load announcements
                await loadAnnouncements();

                // Hide loading
                document.getElementById('loadingOverlay').classList.add('hidden');

            } catch (error) {
                console.error('Init error:', error);
                alert('Failed to load dashboard. Please try again.');
            }
        }

        async function loadUserData() {
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (error) {
                console.error('User data error:', error);
                return;
            }

            userData = data;

            // Update UI
            const firstName = userData.full_name?.split(' ')[0] || 'Warrior';
            document.getElementById('userName').textContent = userData.full_name || 'Warrior';
            document.getElementById('welcomeName').textContent = firstName;
            document.getElementById('userAvatar').textContent = firstName.charAt(0).toUpperCase();

            // Calculate current challenge day
            if (userData.challenge_start_date) {
                const startDate = new Date(userData.challenge_start_date);
                const now = new Date();
                const daysSinceStart = Math.floor((now - startDate) / (24 * 60 * 60 * 1000)) + 1;
                const currentDay = Math.min(Math.max(daysSinceStart, 1), 30);
                document.getElementById('challengeDay').textContent = `Day ${currentDay} of 30`;
            }
        }

        async function loadProgress() {
            const { data, error } = await supabase
                .from('challenge_progress')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('day_number', { ascending: true });

            if (error) {
                console.error('Progress error:', error);
                return;
            }

            progressData = data || [];

            // Calculate stats
            const completedDays = progressData.filter(p => p.quiz_passed || p.task_submitted).length;
            const quizzesPassed = progressData.filter(p => p.quiz_passed).length;
            const tasksCompleted = progressData.filter(p => p.task_submitted).length;
            const totalQuizScore = progressData.reduce((sum, p) => sum + (p.quiz_score || 0), 0);
            const avgScore = quizzesPassed > 0 ? Math.round((totalQuizScore / (quizzesPassed * 5)) * 100) : 0;

            // Update stats UI
            document.getElementById('completedDays').textContent = completedDays;
            document.getElementById('quizzesPassed').textContent = quizzesPassed;
            document.getElementById('tasksCompleted').textContent = tasksCompleted;
            document.getElementById('avgScore').textContent = avgScore + '%';

            // Update progress bar
            const progressPercent = Math.round((completedDays / 30) * 100);
            document.getElementById('progressPercentage').textContent = progressPercent + '%';
            document.getElementById('progressBar').style.width = progressPercent + '%';
            document.getElementById('progressBar').textContent = progressPercent + '%';

            // Render day circles
            renderDayCircles();

            // Update continue button
            updateContinueButton(completedDays);

            // Show certificate button if completed
            if (completedDays >= 30) {
                document.getElementById('certificateBtn').style.display = 'block';
            }
        }

        function renderDayCircles() {
            const phases = [
                { id: 'phase1Days', start: 1, end: 7 },
                { id: 'phase2Days', start: 8, end: 14 },
                { id: 'phase3Days', start: 15, end: 21 },
                { id: 'phase4Days', start: 22, end: 28 },
                { id: 'phase5Days', start: 29, end: 30 }
            ];

            // Calculate current unlocked day based on time
            let currentUnlockedDay = 1;
            if (userData?.challenge_start_date) {
                const startDate = new Date(userData.challenge_start_date);
                const now = new Date();
                const daysSinceStart = Math.floor((now - startDate) / (24 * 60 * 60 * 1000));
                currentUnlockedDay = Math.min(daysSinceStart + 1, 30);
            }

            phases.forEach(phase => {
                const container = document.getElementById(phase.id);
                container.innerHTML = '';

                for (let day = phase.start; day <= phase.end; day++) {
                    const dayProgress = progressData.find(p => p.day_number === day);
                    const isCompleted = dayProgress?.quiz_passed || dayProgress?.task_submitted;
                    
                    // Day is accessible if:
                    // 1. It's day 1
                    // 2. Time has passed (24h per day) AND previous day is completed
                    let isAccessible = day === 1;
                    if (day > 1) {
                        const prevDayProgress = progressData.find(p => p.day_number === day - 1);
                        const prevDayCompleted = prevDayProgress?.quiz_passed || prevDayProgress?.task_submitted;
                        isAccessible = day <= currentUnlockedDay && prevDayCompleted;
                    }

                    const isCurrent = isAccessible && !isCompleted;

                    let statusClass = 'locked';
                    let statusIcon = 'üîí';

                    if (isCompleted) {
                        statusClass = 'completed';
                        statusIcon = '‚úì';
                    } else if (isCurrent) {
                        statusClass = 'current';
                        statusIcon = '‚ñ∂';
                    }

                    const dayCircle = document.createElement('a');
                    dayCircle.className = `day-circle ${statusClass}`;
                    dayCircle.innerHTML = `
                        <span class="day-number">${day}</span>
                        <span class="day-status">${statusIcon}</span>
                    `;

                    if (isAccessible) {
                        dayCircle.href = `/day?day=${day}`;
                    } else {
                        dayCircle.href = '#';
                        dayCircle.onclick = (e) => {
                            e.preventDefault();
                            if (day > currentUnlockedDay) {
                                alert(`Day ${day} unlocks in ${day - currentUnlockedDay} day(s)`);
                            } else {
                                alert(`Complete Day ${day - 1} first to unlock Day ${day}`);
                            }
                        };
                    }

                    container.appendChild(dayCircle);
                }
            });
        }

        function updateContinueButton(completedDays) {
            const btn = document.getElementById('continueBtn');
            const text = document.getElementById('continueText');

            // Find next day to work on
            let nextDay = 1;
            for (let i = 1; i <= 30; i++) {
                const dayProgress = progressData.find(p => p.day_number === i);
                if (!dayProgress?.quiz_passed && !dayProgress?.task_submitted) {
                    nextDay = i;
                    break;
                }
                if (i === 30) nextDay = 30;
            }

            if (completedDays >= 30) {
                text.textContent = 'Review Course';
                btn.href = '/day?day=30';
            } else {
                text.textContent = `Continue Day ${nextDay}`;
                btn.href = `/day?day=${nextDay}`;
            }
        }

        async function loadAnnouncements() {
            try {
                const { data, error } = await supabase
                    .from('live_feed')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error || !data || data.length === 0) {
                    return; // Keep default announcement
                }

                const container = document.getElementById('announcementsList');
                container.innerHTML = '';

                data.forEach(item => {
                    const date = new Date(item.created_at).toLocaleDateString();
                    container.innerHTML += `
                        <div class="announcement-item">
                            <div class="announcement-date">${date}</div>
                            <div class="announcement-text">${item.content}</div>
                        </div>
                    `;
                });
            } catch (e) {
                console.error('Announcements error:', e);
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = '/login';
        }
    </script>
</body>
</html>
