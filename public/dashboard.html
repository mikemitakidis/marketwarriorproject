<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Market Warrior</title>
    <link rel="icon" type="image/png" href="/logo.png">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #f1f5f9;
        }

        /* Header */
        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo img {
            width: 45px;
            height: 45px;
            border-radius: 10px;
        }

        .logo h1 {
            font-size: 1.4em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: white;
        }

        .user-status {
            font-size: 0.8em;
            color: #10b981;
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1em;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .btn-logout {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px;
        }

        /* Welcome Section */
        .welcome-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .welcome-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 30px;
        }

        .welcome-text h2 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .welcome-text p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .welcome-text .motivational {
            margin-top: 15px;
            font-style: italic;
            opacity: 0.85;
            font-size: 0.95em;
        }

        .countdown-box {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px 35px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .countdown-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .countdown-time {
            font-size: 2.2em;
            font-weight: 700;
            font-family: 'SF Mono', Monaco, monospace;
            letter-spacing: 2px;
        }

        .countdown-note {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 8px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-card.green::before { background: linear-gradient(90deg, #10b981, #059669); }
        .stat-card.orange::before { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .stat-card.blue::before { background: linear-gradient(90deg, #3b82f6, #2563eb); }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255,255,255,0.2);
        }

        .stat-icon {
            font-size: 2em;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.green .stat-value {
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            background-clip: text;
        }

        .stat-card.orange .stat-value {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            -webkit-background-clip: text;
            background-clip: text;
        }

        .stat-card.blue .stat-value {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            -webkit-background-clip: text;
            background-clip: text;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.85em;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .quick-actions { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 500px) {
            .quick-actions { grid-template-columns: 1fr; }
        }

        .action-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: inherit;
        }

        .action-card:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-5px);
            border-color: #667eea;
        }

        .action-card.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
        }

        .action-card.primary:hover {
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .action-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .action-card h3 {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: white;
        }

        .action-card p {
            font-size: 0.85em;
            color: #94a3b8;
        }

        .action-card.primary p {
            color: rgba(255,255,255,0.8);
        }

        /* Progress Section */
        .progress-section {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .progress-header h2 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-percentage {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
        }

        .overall-progress {
            margin-bottom: 30px;
        }

        .progress-bar-container {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            height: 24px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            border-radius: 12px;
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            font-weight: 700;
            font-size: 0.85em;
            min-width: 50px;
        }

        /* Days Grid */
        .days-section {
            margin-bottom: 30px;
        }

        .days-section h3 {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .phase-badge {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 12px;
        }

        .day-circle {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            margin: 0 auto;
        }

        .day-circle:hover:not(.locked) {
            transform: scale(1.1);
        }

        .day-circle.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .day-circle.current {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 5px 30px rgba(102, 126, 234, 0.6); }
        }

        .day-circle.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .day-number {
            font-weight: 700;
            font-size: 1.1em;
        }

        .day-status {
            font-size: 0.7em;
            margin-top: 2px;
        }

        /* Affiliate Section */
        .affiliate-section {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1));
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
        }

        .affiliate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .affiliate-header h2 {
            color: #fbbf24;
        }

        .commission-badge {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
        }

        .affiliate-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 600px) {
            .affiliate-stats { grid-template-columns: 1fr; }
        }

        .affiliate-stat {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .affiliate-stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #fbbf24;
        }

        .affiliate-stat-label {
            color: #d4a574;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .affiliate-link-box {
            display: flex;
            gap: 10px;
        }

        .affiliate-link-box input {
            flex: 1;
            padding: 15px;
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            color: #fbbf24;
            font-size: 0.95em;
        }

        .btn-copy {
            padding: 15px 25px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-copy:hover {
            background: #d97706;
        }

        /* Certificate Section */
        .certificate-section {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            padding: 35px;
            text-align: center;
            display: none;
        }

        .certificate-section.show {
            display: block;
        }

        .certificate-section h2 {
            color: #10b981;
            margin-bottom: 15px;
        }

        .certificate-section p {
            color: #6ee7b7;
            margin-bottom: 25px;
        }

        .btn-certificate {
            display: inline-block;
            padding: 15px 35px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 700;
            transition: all 0.3s;
        }

        .btn-certificate:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        /* Access Expiry Warning */
        .expiry-warning {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .expiry-warning.hidden {
            display: none;
        }

        .expiry-warning span {
            color: #fca5a5;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 15px;
            }
            
            .container {
                padding: 90px 15px 30px;
            }
            
            .welcome-section {
                padding: 25px;
            }
            
            .welcome-text h2 {
                font-size: 1.6em;
            }
            
            .countdown-box {
                width: 100%;
            }
            
            .user-details {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <a href="/dashboard" class="logo">
            <img src="/logo.png" alt="Market Warrior">
            <h1>Market Warrior</h1>
        </a>
        
        <div class="header-right">
            <div class="user-info">
                <div class="user-details">
                    <div class="user-name" id="headerUserName">Loading...</div>
                    <div class="user-status">‚óè Active</div>
                </div>
                <div class="user-avatar" id="userAvatar">?</div>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Access Expiry Warning -->
        <div class="expiry-warning hidden" id="expiryWarning">
            <span>‚ö†Ô∏è</span>
            <span id="expiryText">Your access expires in X days. Complete the challenge before then!</span>
        </div>

        <!-- Welcome Section -->
        <div class="welcome-section">
            <div class="welcome-content">
                <div class="welcome-text">
                    <h2>Welcome back, <span id="welcomeName">Warrior</span>! üëã</h2>
                    <p>Continue your trading journey where you left off.</p>
                    <p class="motivational" id="motivationalQuote">"The stock market is filled with individuals who know the price of everything, but the value of nothing."</p>
                </div>
                
                <div class="countdown-box" id="countdownBox" style="display: none;">
                    <div class="countdown-label">Next Day Unlocks In</div>
                    <div class="countdown-time" id="countdownTime">00:00:00</div>
                    <div class="countdown-note">Keep learning while you wait!</div>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value" id="currentDay">1</div>
                <div class="stat-label">Current Day</div>
            </div>
            <div class="stat-card green">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="daysCompleted">0</div>
                <div class="stat-label">Days Completed</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="avgQuizScore">0%</div>
                <div class="stat-label">Avg Quiz Score</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value" id="progressPercentage">0%</div>
                <div class="stat-label">Overall Progress</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="#" class="action-card primary" id="continueBtn">
                <div class="action-icon">‚ñ∂Ô∏è</div>
                <h3>Continue Learning</h3>
                <p id="continueText">Go to Day 1</p>
            </a>
            <a href="/journal" class="action-card">
                <div class="action-icon">üìì</div>
                <h3>Trading Journal</h3>
                <p>Track your trades</p>
            </a>
            <a href="#affiliateSection" class="action-card" id="affiliateAction">
                <div class="action-icon">üí∞</div>
                <h3>Affiliate Program</h3>
                <p>Earn 30% commission</p>
            </a>
            <a href="/certificate" class="action-card" id="certificateAction" style="display: none;">
                <div class="action-icon">üéì</div>
                <h3>Your Certificate</h3>
                <p>Download now!</p>
            </a>
        </div>

        <!-- Progress Section -->
        <div class="progress-section">
            <div class="progress-header">
                <h2>üìà Your Progress</h2>
                <span class="progress-percentage" id="progressDisplay">0%</span>
            </div>

            <div class="overall-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%">
                        <span id="progressText">0%</span>
                    </div>
                </div>
            </div>

            <!-- Phase 1 -->
            <div class="days-section">
                <h3>üìö Phase 1: Trading Foundations <span class="phase-badge">Days 1-7</span></h3>
                <div class="days-grid" id="phase1"></div>
            </div>

            <!-- Phase 2 -->
            <div class="days-section">
                <h3>üìä Phase 2: Technical Analysis <span class="phase-badge">Days 8-14</span></h3>
                <div class="days-grid" id="phase2"></div>
            </div>

            <!-- Phase 3 -->
            <div class="days-section">
                <h3>üéØ Phase 3: Advanced Strategies <span class="phase-badge">Days 15-21</span></h3>
                <div class="days-grid" id="phase3"></div>
            </div>

            <!-- Phase 4 -->
            <div class="days-section">
                <h3>üíº Phase 4: Portfolio Management <span class="phase-badge">Days 22-28</span></h3>
                <div class="days-grid" id="phase4"></div>
            </div>

            <!-- Phase 5 -->
            <div class="days-section">
                <h3>üéì Phase 5: Assessment & Graduation <span class="phase-badge">Days 29-30</span></h3>
                <div class="days-grid" id="phase5"></div>
            </div>
        </div>

        <!-- Affiliate Section -->
        <div class="affiliate-section" id="affiliateSection">
            <div class="affiliate-header">
                <h2>üí∞ Your Affiliate Dashboard</h2>
                <span class="commission-badge">30% Commission</span>
            </div>

            <div class="affiliate-stats">
                <div class="affiliate-stat">
                    <div class="affiliate-stat-value" id="totalReferrals">0</div>
                    <div class="affiliate-stat-label">Total Referrals</div>
                </div>
                <div class="affiliate-stat">
                    <div class="affiliate-stat-value" id="pendingEarnings">$0.00</div>
                    <div class="affiliate-stat-label">Pending Earnings</div>
                </div>
                <div class="affiliate-stat">
                    <div class="affiliate-stat-value" id="paidEarnings">$0.00</div>
                    <div class="affiliate-stat-label">Total Paid</div>
                </div>
            </div>

            <p style="color: #d4a574; margin-bottom: 15px;">Share your unique link and earn $12 for every friend who joins!</p>

            <div class="affiliate-link-box">
                <input type="text" id="affiliateLink" readonly value="Loading...">
                <button class="btn-copy" onclick="copyAffiliateLink()">Copy Link</button>
            </div>
        </div>

        <!-- Certificate Section (shown when completed) -->
        <div class="certificate-section" id="certificateSection">
            <h2>üéâ Congratulations, Market Warrior!</h2>
            <p>You've successfully completed the 30-Day Trading Challenge! Download your certificate below.</p>
            <a href="/certificate" class="btn-certificate">üéì View Your Certificate</a>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://gvpaendpmwyncdztlczy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cGFlbWRwbXd5bmNkenRsY3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MDY1NTAsImV4cCI6MjA4MDk4MjU1MH0.kg6mlLcHv3APGnIeE7vRJpzF1u8JUyGKsYthXQXEAAE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State
        let currentUser = null;
        let userData = null;
        let progressData = [];
        let quizResults = [];
        
        // Motivational Quotes
        const quotes = [
            '"The stock market is filled with individuals who know the price of everything, but the value of nothing." ‚Äî Phillip Fisher',
            '"Risk comes from not knowing what you\'re doing." ‚Äî Warren Buffett',
            '"The four most dangerous words in investing are: This time it\'s different." ‚Äî Sir John Templeton',
            '"In investing, what is comfortable is rarely profitable." ‚Äî Robert Arnott',
            '"The goal of a successful trader is to make the best trades. Money is secondary." ‚Äî Alexander Elder',
            '"Successful investing takes time, discipline and patience." ‚Äî Warren Buffett',
            '"The market is a device for transferring money from the impatient to the patient." ‚Äî Warren Buffett'
        ];
        
        // Initialize dashboard
        async function init() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    window.location.href = '/login';
                    return;
                }
                
                currentUser = session.user;
                
                // Load user data
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (userError || !user) {
                    window.location.href = '/login';
                    return;
                }
                
                // Check if paid
                if (!user.has_paid) {
                    alert('Your payment is not confirmed. Please purchase the challenge.');
                    window.location.href = '/#pricing';
                    return;
                }
                
                // Check if agreed to terms
                if (!user.agreed_to_terms) {
                    window.location.href = '/welcome';
                    return;
                }
                
                userData = user;
                
                // Load progress
                const { data: progress } = await supabase
                    .from('progress')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('day_number', { ascending: true });
                
                progressData = progress || [];
                
                // Load quiz results
                const { data: quizzes } = await supabase
                    .from('quiz_results')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                quizResults = quizzes || [];
                
                // Load affiliate data
                const { data: referrals } = await supabase
                    .from('referrals')
                    .select('*')
                    .eq('referrer_id', currentUser.id);
                
                // Update UI
                updateUI(referrals || []);
                
                // Hide loading
                document.getElementById('loadingOverlay').classList.add('hidden');
                
            } catch (error) {
                console.error('Init error:', error);
                window.location.href = '/login';
            }
        }
        
        function updateUI(referrals) {
            // User info
            const firstName = userData.full_name ? userData.full_name.split(' ')[0] : 'Warrior';
            document.getElementById('headerUserName').textContent = userData.full_name || 'Warrior';
            document.getElementById('welcomeName').textContent = firstName;
            document.getElementById('userAvatar').textContent = firstName.charAt(0).toUpperCase();
            
            // Motivational quote
            document.getElementById('motivationalQuote').textContent = quotes[Math.floor(Math.random() * quotes.length)];
            
            // Affiliate link
            document.getElementById('affiliateLink').value = `https://marketwarrior.club/?ref=${userData.affiliate_code}`;
            
            // Calculate stats
            const completedDays = progressData.filter(p => p.completed).map(p => p.day_number);
            const maxUnlockedDay = getMaxUnlockedDay();
            const avgScore = calculateAverageQuizScore();
            const progressPercent = Math.round((completedDays.length / 30) * 100);
            
            // Update stats
            document.getElementById('currentDay').textContent = Math.min(maxUnlockedDay, 30);
            document.getElementById('daysCompleted').textContent = completedDays.length;
            document.getElementById('avgQuizScore').textContent = avgScore + '%';
            document.getElementById('progressPercentage').textContent = progressPercent + '%';
            document.getElementById('progressDisplay').textContent = progressPercent + '%';
            document.getElementById('progressBar').style.width = Math.max(progressPercent, 3) + '%';
            document.getElementById('progressText').textContent = progressPercent + '%';
            
            // Continue button
            const nextDay = completedDays.length > 0 ? Math.min(Math.max(...completedDays) + 1, 30) : 1;
            document.getElementById('continueBtn').href = `/day/${nextDay}`;
            document.getElementById('continueText').textContent = `Go to Day ${nextDay}`;
            
            // Affiliate stats
            const totalReferrals = referrals.length;
            const pendingEarnings = referrals.filter(r => r.status === 'pending').reduce((sum, r) => sum + (r.commission || 0), 0);
            const paidEarnings = referrals.filter(r => r.status === 'paid').reduce((sum, r) => sum + (r.commission || 0), 0);
            
            document.getElementById('totalReferrals').textContent = totalReferrals;
            document.getElementById('pendingEarnings').textContent = '$' + pendingEarnings.toFixed(2);
            document.getElementById('paidEarnings').textContent = '$' + paidEarnings.toFixed(2);
            
            // Check if completed
            if (completedDays.length >= 30) {
                document.getElementById('certificateSection').classList.add('show');
                document.getElementById('certificateAction').style.display = 'block';
                document.getElementById('affiliateAction').style.display = 'none';
            }
            
            // Check access expiry
            checkAccessExpiry();
            
            // Update countdown
            updateCountdown();
            
            // Render day circles
            renderDays(completedDays, maxUnlockedDay);
        }
        
        function getMaxUnlockedDay() {
            if (!userData.challenge_start_time) return 1;
            
            const startTime = new Date(userData.challenge_start_time).getTime();
            const now = Date.now();
            const daysPassed = Math.floor((now - startTime) / (24 * 60 * 60 * 1000));
            
            // Also check quiz completion for sequential unlocking
            const completedDays = progressData.filter(p => p.completed).map(p => p.day_number);
            const lastCompletedDay = completedDays.length > 0 ? Math.max(...completedDays) : 0;
            
            // Day is unlocked if: time has passed AND previous day is completed (or it's day 1)
            return Math.min(daysPassed + 1, lastCompletedDay + 1, 30);
        }
        
        function calculateAverageQuizScore() {
            if (quizResults.length === 0) return 0;
            const totalScore = quizResults.reduce((sum, q) => sum + (q.score || 0), 0);
            return Math.round(totalScore / quizResults.length);
        }
        
        function checkAccessExpiry() {
            if (!userData.access_expires_at) return;
            
            const expiryDate = new Date(userData.access_expires_at);
            const now = new Date();
            const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            
            if (daysLeft <= 14) {
                document.getElementById('expiryWarning').classList.remove('hidden');
                document.getElementById('expiryText').textContent = 
                    daysLeft <= 0 
                        ? 'Your access has expired! Contact support to extend.' 
                        : `Your access expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}. Complete the challenge before then!`;
            }
        }
        
        function updateCountdown() {
            if (!userData.challenge_start_time) return;
            
            const completedDays = progressData.filter(p => p.completed).map(p => p.day_number);
            if (completedDays.length >= 30) return;
            
            const startTime = new Date(userData.challenge_start_time).getTime();
            const maxUnlockedDay = getMaxUnlockedDay();
            const nextDayUnlockTime = startTime + (maxUnlockedDay * 24 * 60 * 60 * 1000);
            
            const now = Date.now();
            const remaining = nextDayUnlockTime - now;
            
            if (remaining <= 0) {
                document.getElementById('countdownBox').style.display = 'none';
                return;
            }
            
            document.getElementById('countdownBox').style.display = 'block';
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            document.getElementById('countdownTime').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function renderDays(completedDays, maxUnlockedDay) {
            const phases = {
                phase1: [1, 2, 3, 4, 5, 6, 7],
                phase2: [8, 9, 10, 11, 12, 13, 14],
                phase3: [15, 16, 17, 18, 19, 20, 21],
                phase4: [22, 23, 24, 25, 26, 27, 28],
                phase5: [29, 30]
            };
            
            for (const [phaseId, days] of Object.entries(phases)) {
                const container = document.getElementById(phaseId);
                container.innerHTML = '';
                
                days.forEach(day => {
                    const isCompleted = completedDays.includes(day);
                    const isUnlocked = isDayUnlocked(day, completedDays, maxUnlockedDay);
                    const isCurrent = isUnlocked && !isCompleted;
                    
                    let statusClass = 'locked';
                    let statusText = 'üîí';
                    
                    if (isCompleted) {
                        statusClass = 'completed';
                        statusText = '‚úì';
                    } else if (isCurrent) {
                        statusClass = 'current';
                        statusText = '‚ñ∂';
                    }
                    
                    const circle = document.createElement('div');
                    circle.className = `day-circle ${statusClass}`;
                    circle.innerHTML = `
                        <span class="day-number">${day}</span>
                        <span class="day-status">${statusText}</span>
                    `;
                    
                    if (isUnlocked) {
                        circle.onclick = () => window.location.href = `/day/${day}`;
                    } else {
                        circle.onclick = () => showLockedMessage(day, completedDays);
                    }
                    
                    container.appendChild(circle);
                });
            }
        }
        
        function isDayUnlocked(day, completedDays, maxUnlockedDay) {
            if (day === 1) return true;
            
            // Check if previous day is completed
            const prevDayCompleted = completedDays.includes(day - 1);
            
            // Check if enough time has passed
            const timeUnlocked = day <= maxUnlockedDay;
            
            return prevDayCompleted && timeUnlocked;
        }
        
        function showLockedMessage(day, completedDays) {
            const prevDayCompleted = completedDays.includes(day - 1);
            
            if (!prevDayCompleted) {
                alert(`Complete Day ${day - 1} first to unlock Day ${day}.`);
            } else {
                alert(`Day ${day} will unlock when 24 hours have passed. Keep reviewing previous content!`);
            }
        }
        
        function copyAffiliateLink() {
            const input = document.getElementById('affiliateLink');
            input.select();
            
            try {
                document.execCommand('copy');
            } catch {
                navigator.clipboard.writeText(input.value);
            }
            
            const btn = document.querySelector('.btn-copy');
            btn.textContent = 'Copied! ‚úì';
            setTimeout(() => btn.textContent = 'Copy Link', 2000);
        }
        
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await supabase.auth.signOut();
                window.location.href = '/login';
            }
        }
        
        // Update countdown every second
        setInterval(updateCountdown, 1000);
        
        // Initialize
        init();
    </script>
</body>
</html>
